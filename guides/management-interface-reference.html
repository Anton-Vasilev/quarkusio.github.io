<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>By default, Quarkus exposes the <em>management</em> endpoints under <code>/q</code> on the main HTTP server.
The same HTTP server provides the application endpoints and the management endpoints.</p>
</div>
<div class="paragraph">
<p>This document presents how you can use a separate HTTP server (bound to a different network interface and port) for the management endpoints.
It avoids exposing these endpoints on the main server and, therefore, prevents undesired accesses.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="enabling-the-management-interface"><a class="anchor" href="#enabling-the-management-interface"></a>1. Enabling the management interface</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To enable the management interface, use the following <strong>build-time</strong> property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.management.enabled=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, management endpoints will be exposed on: <code><a href="http://0.0.0.0:9000/q" class="bare">http://0.0.0.0:9000/q</a></code>.
For example, if you have <code>smallrye-health</code> installed, the readiness probe will be exposed at <code><a href="http://0.0.0.0:9000/q/health/ready" class="bare">http://0.0.0.0:9000/q/health/ready</a></code>.</p>
</div>
<div class="paragraph">
<p>SmallRye Health Checks, SmallRye Metrics, Micrometer and Info endpoints will be declared as management endpoints when the management interface is enabled.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The management interface is disabled when no extensions relying on it (such as the SmallRye Health or SmallRye OpenAPI extensions) are installed.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configure-the-host-port-and-scheme"><a class="anchor" href="#configure-the-host-port-and-scheme"></a>2. Configure the host, port and scheme</h2>
<div class="sectionbody">
<div class="paragraph">
<p>By default, the management interface is exposed on the interface: <code>0.0.0.0</code> (all interfaces) and on the port <code>9000</code> (<code>9001</code> in test mode).
It does not use TLS (<code>https</code>) by default.</p>
</div>
<div class="paragraph">
<p>You can configure the host, ports, and TLS certificates using the following properties:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>quarkus.management.host</code> - the interface / host</p>
</li>
<li>
<p><code>quarkus.management.port</code> - the port</p>
</li>
<li>
<p><code>quarkus.management.test-port</code> - the port to use in test mode</p>
</li>
<li>
<p><code>quarkus.management.ssl</code> - the TLS configuration, <a href="http-reference#ssl">same as for the main HTTP server</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here is a configuration example exposing the management interface on <em><a href="https://localhost:9002" class="bare">https://localhost:9002</a></em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.management.enabled=true
quarkus.management.host=localhost
quarkus.management.port=9002
quarkus.management.ssl.certificate.key-store-file=server-keystore.jks
quarkus.management.ssl.certificate.key-store-password=secret</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Unlike the main HTTP server, the management interface does not handle <em>http</em> and <em>https</em> at the same time.
If <em>https</em> is configured, plain HTTP requests will be rejected.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configure-the-root-path"><a class="anchor" href="#configure-the-root-path"></a>3. Configure the root path</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Management endpoints are configured differently than standard HTTP endpoints.
They use a unique root path, which is <code>/q</code> by default.
This management root path can be configured using the <code>quarkus.management.root-path property</code>.
For example, if you want to expose the management endpoints under <code>/management</code> use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.management.enabled=true
quarkus.management.root-path=/management</code></pre>
</div>
</div>
<div class="paragraph">
<p>The mounting rules of the management endpoints slightly differ from the ones used when using the main HTTP server:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Management endpoints configured using a <em>relative</em> path (not starting with <code>/</code>) will be served from the configured root path.
For example, if the endpoint path is <code>health</code> and the root path is <code>management</code>, the resulting path is <code>/management/health</code></p>
</li>
<li>
<p>Management endpoints configured using an <em>absolute</em> path (starting with <code>/</code>) will be served from the root.
For example, if the endpoint path is <code>/health</code>, the resulting path is <code>/health</code>, regardless of the root path</p>
</li>
<li>
<p>The management interface does not use the HTTP root path from the main HTTP server.</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>quarkus.http.root-path</code> property is only applied to the main HTTP server and not to the management interface.
In addition, the <code>quarkus.http.non-application-root-path</code> property is not used for endpoint exposed on the management interface.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="management-endpoint-extension"><a class="anchor" href="#management-endpoint-extension"></a>4. Create a management endpoint in an extension</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
To expose an endpoint on the management interface from the code of an application, refer to <a href="#management-endpoint-application">the application section</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>SmallRye Health Checks, SmallRye Metrics, and Micrometer endpoints will be declared as management endpoints when the management interface is enabled.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
if you do not enable the management interface, these endpoints will be served using the main HTTP server (under <code>/q</code> by default).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Extensions can create a management endpoint by defining a <em>non application</em> route and calling <code>management()</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BuildStep
void createManagementRoute(BuildProducer&lt;RouteBuildItem&gt; routes,
        NonApplicationRootPathBuildItem nonApplicationRootPathBuildItem,
        MyRecorder recorder) {

    routes.produce(nonApplicationRootPathBuildItem.routeBuilder()
        .management() // Must be called BEFORE the routeFunction method
        .routeFunction("my-path", recorder.route())
        .handler(recorder.getHandler())
        .blockingRoute()
        .build());
    //...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the management interface is enabled, the endpoint will be exposed on: <code><a href="http://0.0.0.0:9000/q/my-path" class="bare">http://0.0.0.0:9000/q/my-path</a></code>.
Otherwise, it will be exposed on: <code><a href="http://localhost:8080/q/my-path" class="bare">http://localhost:8080/q/my-path</a></code>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Management endpoints can only be declared by extensions and not from the application code.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="management-endpoint-application"><a class="anchor" href="#management-endpoint-application"></a>5. Exposing an endpoint on the management interface (as an application)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can expose endpoints on the management interface by registering routes on the management router.
To access the router use the following code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public void registerManagementRoutes(@Observes ManagementInterface mi) {
       mi.router().get("/admin").handler(rc -&gt;
            rc.response().end("admin it is")
       );
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>io.quarkus.vertx.http.ManagementInterface</code> event is fired when the management interface is initialized.
So, if the management interface is not enabled, the method won&#8217;t be called.</p>
</div>
<div class="paragraph">
<p>The <code>router()</code> method returns a <code>io.vertx.ext.web.Router</code> object which can be used to register routes.
The paths are relative to <code>/</code>.
For example, the previous snippet registers a route on <code>/admin</code>.
This route is accessible on <code><a href="http://0.0.0.0:9000/admin" class="bare">http://0.0.0.0:9000/admin</a></code>, if you use the default host and port.</p>
</div>
<div class="paragraph">
<p>More details about the <code>Router</code> API can be found on <a href="https://vertx.io/docs/vertx-web/java/">the Vert.x Web documentation</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="management-interface-configuration"><a class="anchor" href="#management-interface-configuration"></a>6. Management Interface Configuration</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="reverse-proxy"><a class="anchor" href="#reverse-proxy"></a>7. Running behind a reverse proxy</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Quarkus can be accessed through proxies that generate headers (e.g. <code>X-Forwarded-Host</code>) to preserve information about the original request.
Quarkus can be configured to automatically update information like protocol, host, port and URI to use the values from those headers.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Activating this feature can expose the server to security issues like information spoofing.
Activate it only when running behind a reverse proxy.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To set up this feature for the management interface, include the following lines in <code>src/main/resources/application.properties</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.management.proxy.proxy-address-forwarding=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>To constrain this behavior to the standard <code>Forwarded</code> header (and ignore <code>X-Forwarded</code> variants) by setting <code>quarkus.management.proxy.allow-forwarded</code> in <code>src/main/resources/application.properties</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.management.proxy.allow-forwarded=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, you can prefer <code>X-Forwarded-*</code> headers using the following configuration in <code>src/main/resources/application.properties</code> (note <code>allow-x-forwarded</code> instead of <code>allow-forwarded</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.management.proxy.proxy-address-forwarding=true
quarkus.management.proxy.allow-x-forwarded=true
quarkus.management.proxy.enable-forwarded-host=true
quarkus.management.proxy.enable-forwarded-prefix=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>Supported forwarding address headers are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Forwarded</code></p>
</li>
<li>
<p><code>X-Forwarded-Proto</code></p>
</li>
<li>
<p><code>X-Forwarded-Host</code></p>
</li>
<li>
<p><code>X-Forwarded-Port</code></p>
</li>
<li>
<p><code>X-Forwarded-Ssl</code></p>
</li>
<li>
<p><code>X-Forwarded-Prefix</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If both header variants (<code>Forwarded</code> and <code>X-Forwarded-*</code>) are enabled, the <code>Forwarded</code> header will have precedence.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Using both <code>Forwarded</code> and <code>X-Forwarded</code> headers can have security implications as it may allow clients to forge requests with a header that is not overwritten by the proxy.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Ensure that your proxy is configured to strip unexpected <code>Forwarded</code> or <code>X-Forwarded-*</code> headers from the client request.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="kubernetes"><a class="anchor" href="#kubernetes"></a>8. Kubernetes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When Quarkus generates the Kubernetes metadata, it checks if the management interface is enabled and configures the probes accordingly.
The resulting descriptor defines the main HTTP port (named <code>http</code>) and the management port (named <code>management</code>).
Health probes (using HTTP actions) and Prometheus scrape URLs are configured using the <code>management</code> port.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">KNative</div>
<div class="paragraph">
<p>Until <a href="https://github.com/knative/serving/issues/8471">KNative#8471</a> is resolved, you cannot use the management interface, as KNative does not support containers will multiple exposed ports.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="security"><a class="anchor" href="#security"></a>9. Security</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can enable <em>basic</em> authentication using the following properties:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.management.enabled=true
# Enable basic authentication
quarkus.management.auth.basic=true
# Require all access to /q/* to be authenticated
quarkus.management.auth.permission.all.policy=authenticated
quarkus.management.auth.permission.all.paths=/q/*</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also use different permissions for different paths or use role bindings:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.management.enabled=true
# Enable basic authentication
quarkus.management.auth.basic=true
# Configure a management policy if needed, here the policy `management-policy` requires users to have the role `management`.
quarkus.management.auth.policy.management-policy.roles-allowed=management

# For each endpoint you can configure the permissions
# Health used the management-policy (so requires authentication + the `management` role)
quarkus.management.auth.permission.health.paths=/q/health/*
quarkus.management.auth.permission.health.policy=management-policy

# Metrics just requires authentication
quarkus.management.auth.permission.metrics.paths=/q/metrics/*
quarkus.management.auth.permission.metrics.policy=authenticated</code></pre>
</div>
</div>
<div class="paragraph">
<p>More details about Basic authentication in Quarkus can be found in the <a href="security-basic-authentication-howto">Basic authentication guide</a>.</p>
</div>
</div>
</div>