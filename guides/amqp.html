<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This guide demonstrates how your Quarkus application can utilize SmallRye Reactive Messaging to interact with AMQP 1.0.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
If you want to use RabbitMQ, you should use the <a href="rabbitmq">SmallRye Reactive Messaging RabbitMQ extension</a>.
Alternatively, if you want to use RabbitMQ with AMQP 1.0 you need to enable the AMQP 1.0 plugin in the RabbitMQ broker;
check the <a href="https://smallrye.io/smallrye-reactive-messaging/smallrye-reactive-messaging/3.9/amqp/amqp.html#amqp-rabbitmq">connecting to RabbitMQ</a>
documentation.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="prerequisites"><a class="anchor" href="#prerequisites"></a>Prerequisites</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Unresolved directive in amqp.adoc - include::{includes}/prerequisites.adoc[]</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="architecture"><a class="anchor" href="#architecture"></a>Architecture</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this guide, we are going to develop two applications communicating with an AMQP broker.
We will use <a href="https://activemq.apache.org/components/artemis/">Artemis</a>, but you can use any AMQP 1.0 broker.
The first application sends a <em>quote request</em> to an AMQP queue and consumes messages from the <em>quote</em> queue.
The second application receives the <em>quote request</em> and sends a <em>quote</em> back.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="amqp-qs-architecture.png" alt="Architecture" width="80%">
</div>
</div>
<div class="paragraph">
<p>The first application, the <code>producer</code>, will let the user request some quotes over an HTTP endpoint.
For each quote request, a random identifier is generated and returned to the user, to put the quote request on <em>pending</em>.
At the same time the generated request id is sent over the <code>quote-requests</code> queue.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="amqp-qs-app-screenshot.png" alt="Producer App UI">
</div>
</div>
<div class="paragraph">
<p>The second application, the <code>processor</code>, in turn, will read from the <code>quote-requests</code> queue put a random price to the quote, and send it to a queue named <code>quotes</code>.</p>
</div>
<div class="paragraph">
<p>Lastly, the <code>producer</code> will read the quotes and send them to the browser using server-sent events.
The user will therefore see the quote price updated from <em>pending</em> to the received price in real-time.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="solution"><a class="anchor" href="#solution"></a>Solution</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We recommend that you follow the instructions in the next sections and create applications step by step.
However, you can go right to the completed example.</p>
</div>
<div class="paragraph">
<p>Clone the Git repository: <code>git clone <a href="https://github.com/quarkusio/quarkus-quickstarts.git" class="bare">https://github.com/quarkusio/quarkus-quickstarts.git</a></code>, or download an <a href="https://github.com/quarkusio/quarkus-quickstarts/archive/main.zip">archive</a>.</p>
</div>
<div class="paragraph">
<p>The solution is located in the <code>amqp-quickstart</code> <a href="https://github.com/quarkusio/quarkus-quickstarts/tree/main/amqp-quickstart">directory</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="creating-the-maven-project"><a class="anchor" href="#creating-the-maven-project"></a>Creating the Maven Project</h2>
<div class="sectionbody">
<div class="paragraph">
<p>First, we need to create two projects: the <em>producer</em> and the <em>processor</em>.</p>
</div>
<div class="paragraph">
<p>To create the <em>producer</em> project, in a terminal run:</p>
</div>
<div class="paragraph">
<p>Unresolved directive in amqp.adoc - include::{includes}/devtools/create-app.adoc[]</p>
</div>
<div class="paragraph">
<p>This command creates the project structure and select the two Quarkus extensions we will be using:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>RESTEasy Reactive and its Jackson support to handle JSON payloads</p>
</li>
<li>
<p>The Reactive Messaging AMQP connector</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>To create the <em>processor</em> project, from the same directory, run:</p>
</div>
<div class="paragraph">
<p>Unresolved directive in amqp.adoc - include::{includes}/devtools/create-app.adoc[]</p>
</div>
<div class="paragraph">
<p>At that point you should have the following structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">.
├── amqp-quickstart-processor
│  ├── README.md
│  ├── mvnw
│  ├── mvnw.cmd
│  ├── pom.xml
│  └── src
│     └── main
│        ├── docker
│        ├── java
│        └── resources
│           └── application.properties
└── amqp-quickstart-producer
   ├── README.md
   ├── mvnw
   ├── mvnw.cmd
   ├── pom.xml
   └── src
      └── main
         ├── docker
         ├── java
         └── resources
            └── application.properties</code></pre>
</div>
</div>
<div class="paragraph">
<p>Open the two projects in your favorite IDE.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="the-quote-object"><a class="anchor" href="#the-quote-object"></a>The Quote object</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>Quote</code> class will be used in both <code>producer</code> and <code>processor</code> projects.
For the sake of simplicity we will duplicate the class.
In both projects, create the <code>src/main/java/org/acme/amqp/model/Quote.java</code> file, with the following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme.amqp.model;

import io.quarkus.runtime.annotations.RegisterForReflection;

@RegisterForReflection
public class Quote {

    public String id;
    public int price;

    /**
    * Default constructor required for Jackson serializer
    */
    public Quote() { }

    public Quote(String id, int price) {
        this.id = id;
        this.price = price;
    }

    @Override
    public String toString() {
        return "Quote{" +
                "id='" + id + '\'' +
                ", price=" + price +
                '}';
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>JSON representation of <code>Quote</code> objects will be used in messages sent to the AMQP queues
and also in the server-sent events sent to browser clients.</p>
</div>
<div class="paragraph">
<p>Quarkus has built-in capabilities to deal with JSON AMQP messages.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">@RegisterForReflection</div>
<div class="paragraph">
<p>The <code>@RegisterForReflection</code> annotation instructs Quarkus to include the class (including fields and methods) when building the native executable.
This will be useful later when we run the applications as native executables inside containers.
Without, the native compilation would remove the fields and methods during the dead-code elimination phase.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sending-quote-request"><a class="anchor" href="#sending-quote-request"></a>Sending quote request</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Inside the <code>producer</code> project locate the generated  <code>src/main/java/org/acme/amqp/producer/QuotesResource.java</code> file, and update the content to be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme.amqp.producer;

import java.util.UUID;

import jakarta.ws.rs.GET;
import jakarta.ws.rs.POST;
import jakarta.ws.rs.Path;
import jakarta.ws.rs.Produces;
import jakarta.ws.rs.core.MediaType;

import org.acme.amqp.model.Quote;
import org.eclipse.microprofile.reactive.messaging.Channel;
import org.eclipse.microprofile.reactive.messaging.Emitter;

import io.smallrye.mutiny.Multi;

@Path("/quotes")
public class QuotesResource {

    @Channel("quote-requests") Emitter&lt;String&gt; quoteRequestEmitter; <i class="conum" data-value="1"></i><b>(1)</b>

    /**
     * Endpoint to generate a new quote request id and send it to "quote-requests" AMQP queue using the emitter.
     */
    @POST
    @Path("/request")
    @Produces(MediaType.TEXT_PLAIN)
    public String createRequest() {
        UUID uuid = UUID.randomUUID();
        quoteRequestEmitter.send(uuid.toString()); <i class="conum" data-value="2"></i><b>(2)</b>
        return uuid.toString();
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Inject a Reactive Messaging <code>Emitter</code> to send messages to the <code>quote-requests</code> channel.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>On a post request, generate a random UUID and send it to the AMQP queue using the emitter.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>quote-requests</code> channel is going to be managed as a AMQP queue, as that&#8217;s the only connector on the classpath.
If not indicated otherwise, like in this example, Quarkus uses the channel name as AMQP queue name.
So, in this example, the application sends messages to the <code>quote-requests</code> queue.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
When you have multiple connectors, you would need to indicate which connector you want to use in the application configuration.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="processing-quote-requests"><a class="anchor" href="#processing-quote-requests"></a>Processing quote requests</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now let&#8217;s consume the quote request and give out a price.
Inside the <code>processor</code> project, locate the <code>src/main/java/org/acme/amqp/processor/QuoteProcessor.java</code> file and add the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme.amqp.processor;

import java.util.Random;

import jakarta.enterprise.context.ApplicationScoped;

import org.acme.amqp.model.Quote;
import org.eclipse.microprofile.reactive.messaging.Incoming;
import org.eclipse.microprofile.reactive.messaging.Outgoing;

import io.smallrye.reactive.messaging.annotations.Blocking;

/**
 * A bean consuming data from the "request" AMQP queue and giving out a random quote.
 * The result is pushed to the "quotes" AMQP queue.
 */
@ApplicationScoped
public class QuoteProcessor {

    private Random random = new Random();

    @Incoming("requests")       <i class="conum" data-value="1"></i><b>(1)</b>
    @Outgoing("quotes")         <i class="conum" data-value="2"></i><b>(2)</b>
    @Blocking                   <i class="conum" data-value="3"></i><b>(3)</b>
    public Quote process(String quoteRequest) throws InterruptedException {
        // simulate some hard-working task
        Thread.sleep(200);
        return new Quote(quoteRequest, random.nextInt(100));
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Indicates that the method consumes the items from the <code>requests</code> channel</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Indicates that the objects returned by the method are sent to the <code>quotes</code> channel</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Indicates that the processing is <em>blocking</em> and cannot be run on the caller thread.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>process</code> method is called for every AMQP message from the <code>quote-requests</code> queue, and will send a <code>Quote</code> object to the <code>quotes</code> queue.</p>
</div>
<div class="paragraph">
<p>Because we want to consume messages from the <code>quotes-requests</code> queue into the <code>requests</code> channel, we need to configure this association.
Open the <code>src/main/resources/application.properties</code> file and add:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">mp.messaging.incoming.requests.address=quote-requests</code></pre>
</div>
</div>
<div class="paragraph">
<p>The configuration keys are structured as follows:</p>
</div>
<div class="paragraph">
<p><code>mp.messaging.[outgoing|incoming].{channel-name}.property=value</code></p>
</div>
<div class="paragraph">
<p>In our case, we want to configure the <code>address</code> attribute to indicate the name of the queue.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="receiving-quotes"><a class="anchor" href="#receiving-quotes"></a>Receiving quotes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Back to our <code>producer</code> project.
Let&#8217;s modify the <code>QuotesResource</code> to consume quotes, bind it to an HTTP endpoint to send events to clients:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import io.smallrye.mutiny.Multi;
//...

@Channel("quotes") Multi&lt;Quote&gt; quotes;     <i class="conum" data-value="1"></i><b>(1)</b>

/**
 * Endpoint retrieving the "quotes" queue and sending the items to a server sent event.
 */
@GET
@Produces(MediaType.SERVER_SENT_EVENTS) <i class="conum" data-value="2"></i><b>(2)</b>
public Multi&lt;Quote&gt; stream() {
    return quotes; <i class="conum" data-value="3"></i><b>(3)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Injects the <code>quotes</code> channel using the <code>@Channel</code> qualifier</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Indicates that the content is sent using <code>Server Sent Events</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Returns the stream (<em>Reactive Stream</em>)</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="the-html-page"><a class="anchor" href="#the-html-page"></a>The HTML page</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Final touch, the HTML page reading the converted prices using SSE.</p>
</div>
<div class="paragraph">
<p>Create inside the <code>producer</code> project <code>src/main/resources/META-INF/resources/quotes.html</code> file, with the following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">&lt;!DOCTYPE html&gt; &lt;html lang="en"&gt; &lt;head&gt; &lt;meta charset="UTF-8"&gt; &lt;title&gt;Quotes&lt;/title&gt;

    &lt;link rel="stylesheet" type="text/css"
          href="https://cdnjs.cloudflare.com/ajax/libs/patternfly/3.24.0/css/patternfly.min.css"&gt;
    &lt;link rel="stylesheet" type="text/css"
          href="https://cdnjs.cloudflare.com/ajax/libs/patternfly/3.24.0/css/patternfly-additions.min.css"&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div class="container"&gt;
    &lt;div class="card"&gt;
        &lt;div class="card-body"&gt;
            &lt;h2 class="card-title"&gt;Quotes&lt;/h2&gt;
            &lt;button class="btn btn-info" id="request-quote"&gt;Request Quote&lt;/button&gt;
            &lt;div class="quotes"&gt;&lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;script src="https://code.jquery.com/jquery-3.6.0.min.js"&gt;&lt;/script&gt;
&lt;script&gt;
    $("#request-quote").click((event) =&gt; {
        fetch("/quotes/request", {method: "POST"})
        .then(res =&gt; res.text())
        .then(qid =&gt; {
            var row = $(`&lt;h4 class='col-md-12' id='${qid}'&gt;Quote # &lt;i&gt;${qid}&lt;/i&gt; | &lt;strong&gt;Pending&lt;/strong&gt;&lt;/h4&gt;`);
            $(".quotes").append(row);
        });
    });
    var source = new EventSource("/quotes");
    source.onmessage = (event) =&gt; {
      var json = JSON.parse(event.data);
      $(`#${json.id}`).html(function(index, html) {
        return html.replace("Pending", `\$\xA0${json.price}`);
      });
    };
&lt;/script&gt;
&lt;/html&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nothing spectacular here.
On each received quote, it updates the page.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="get-it-running"><a class="anchor" href="#get-it-running"></a>Get it running</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You just need to run both applications using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">&gt; mvn -f amqp-quickstart-producer quarkus:dev</code></pre>
</div>
</div>
<div class="paragraph">
<p>And, in a separate terminal:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">&gt; mvn -f amqp-quickstart-processor quarkus:dev</code></pre>
</div>
</div>
<div class="paragraph">
<p>Quarkus starts a AMQP broker automatically, configures the application and shares the broker instance between different applications.
See <a href="amqp-dev-services">Dev Services for AMQP</a> for more details.</p>
</div>
<div class="paragraph">
<p>Open <code><a href="http://localhost:8080/quotes.html" class="bare">http://localhost:8080/quotes.html</a></code> in your browser and request some quotes by clicking the button.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="running-in-jvm-or-native-mode"><a class="anchor" href="#running-in-jvm-or-native-mode"></a>Running in JVM or Native mode</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When not running in dev or test mode, you will need to start your AMQP broker.
You can follow the instructions from the <a href="https://activemq.apache.org/components/artemis/documentation/latest/using-server.html">Apache ActiveMQ Artemis website</a> or create a <code>docker-compose.yaml</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">version: '2'

services:

  artemis:
    image: quay.io/artemiscloud/activemq-artemis-broker:0.1.2
    ports:
      - "8161:8161"
      - "61616:61616"
      - "5672:5672"
    environment:
      AMQ_USER: quarkus
      AMQ_PASSWORD: quarkus
    networks:
      - amqp-quickstart-network

  producer:
    image: quarkus-quickstarts/amqp-quickstart-producer:1.0-${QUARKUS_MODE:-jvm}
    build:
      context: amqp-quickstart-producer
      dockerfile: src/main/docker/Dockerfile.${QUARKUS_MODE:-jvm}
    environment:
      AMQP_HOST: artemis
      AMQP_PORT: 5672
    ports:
      - "8080:8080"
    networks:
      - amqp-quickstart-network

  processor:
    image: quarkus-quickstarts/amqp-quickstart-processor:1.0-${QUARKUS_MODE:-jvm}
    build:
      context: amqp-quickstart-processor
      dockerfile: src/main/docker/Dockerfile.${QUARKUS_MODE:-jvm}
    environment:
      AMQP_HOST: artemis
      AMQP_PORT: 5672
    networks:
      - amqp-quickstart-network

networks:
  amqp-quickstart-network:
    name: amqp-quickstart</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note how the AMQP broker location is configured.
The <code>amqp.host</code> and <code>amqp.port</code> (<code>AMQP_HOST</code> and <code>AMQP_PORT</code> environment variables) properties configure location.</p>
</div>
<div class="paragraph">
<p>First, make sure you stopped the applications, and build both applications in JVM mode with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">&gt; mvn -f amqp-quickstart-producer clean package
&gt; mvn -f amqp-quickstart-processor clean package</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once packaged, run <code>docker compose up --build</code>.
The UI is exposed on <a href="http://localhost:8080/quotes.html" class="bare">http://localhost:8080/quotes.html</a></p>
</div>
<div class="paragraph">
<p>To run your applications as native, first we need to build the native executables:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">&gt; mvn -f amqp-quickstart-producer package -Dnative  -Dquarkus.native.container-build=true
&gt; mvn -f amqp-quickstart-processor package -Dnative -Dquarkus.native.container-build=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>-Dquarkus.native.container-build=true</code> instructs Quarkus to build Linux 64bits native executables, who can run inside containers.
Then, run the system using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">&gt; export QUARKUS_MODE=native
&gt; docker compose up --build</code></pre>
</div>
</div>
<div class="paragraph">
<p>As before, the UI is exposed on <a href="http://localhost:8080/quotes.html" class="bare">http://localhost:8080/quotes.html</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="going-further"><a class="anchor" href="#going-further"></a>Going further</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This guide has shown how you can interact with AMQP 1.0 using Quarkus.
It utilizes <a href="https://smallrye.io/smallrye-reactive-messaging">SmallRye Reactive Messaging</a> to build data streaming applications.</p>
</div>
<div class="paragraph">
<p>If you did the Kafka quickstart, you have realized that it&#8217;s the same code.
The only difference is the connector configuration and the JSON mapping.</p>
</div>
</div>
</div>