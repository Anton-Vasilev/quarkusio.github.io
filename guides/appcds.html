<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This reference guide explains how to enable Application Class Data Sharing in your Quarkus applications.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="what-is-application-class-data-sharing-appcds"><a class="anchor" href="#what-is-application-class-data-sharing-appcds"></a>What is Application Class Data Sharing (AppCDS)?</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://docs.oracle.com/en/java/javase/17/docs/specs/man/java.html#application-class-data-sharing">Application Class Data Sharing</a> is a JVM feature that helps reduce the startup time and memory footprint of a JVM application.
This is achieved by having the JVM create a pre-processed shared archived of classes that are loaded at startup time. As these classes
are loaded every time the application starts, AppCDS is a conceptually simple way of improving the application startup time,
without the application itself having to be coded or configured in a specific way. How much of an improvement depends on many factors, such as the number of classes loaded, the underlying hardware etc.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="vanilla-appcds-generation"><a class="anchor" href="#vanilla-appcds-generation"></a>Vanilla AppCDS generation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The main downside of creating AppCDS manually for an application is that their generation requires launching the application with special flags and obtaining the archive in a step before the application is deployed to production.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The exact process depends on the JVM version being used as newer JVM have incrementally made the process easier.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This fact makes the use of AppCDS difficult to use for real world deployments where a CI pipeline is responsible for building and deploying applications.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appcds-in-quarkus"><a class="anchor" href="#appcds-in-quarkus"></a>AppCDS in Quarkus</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="creating-the-archive"><a class="anchor" href="#creating-the-archive"></a>Creating the archive</h3>
<div class="paragraph">
<p>Quarkus makes AppCDS generation as simple as setting the <code>quarkus.package.create-appcds</code> configuration property to <code>true</code>.
For an example Quarkus application using Maven (assuming it is located in <code>/tmp/code-with-quarkus</code>), the AppCDS archive can be generated by simply building the application like so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./mvnw package -Dquarkus.package.create-appcds=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the build completes, the output will contain (among other things) the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[INFO] [io.quarkus.deployment.pkg.steps.AppCDSBuildStep] Launching AppCDS creation process.
[INFO] [io.quarkus.deployment.pkg.steps.AppCDSBuildStep] AppCDS successfully created at: '/tmp/code-with-quarkus/target/quarkus-app/app-cds.jsa'.
[INFO] [io.quarkus.deployment.pkg.steps.AppCDSBuildStep] To ensure they are loaded properly, run the application jar from its directory and also add the '-XX:SharedArchiveFile=app-cds.jsa' JVM flag.
Moreover, make sure to use the exact same Java version (x.y.z) to run the application as was used to build it.</code></pre>
</div>
</div>
<div class="paragraph">
<p>If we take a look at <code>/tmp/code-with-quarkus/target/quarkus-app</code>, among the other files, we see <code>app-cds.jsa</code>, which is the generated AppCDS archive.</p>
</div>
</div>
<div class="sect2">
<h3 id="using-the-archive"><a class="anchor" href="#using-the-archive"></a>Using the archive</h3>
<div class="paragraph">
<p>Using the archive is done by using the <code>-XX:SharedArchiveFile</code> flag. However, a few caveats apply:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The paths to the Quarkus jar file and the AppCDS archive need to be exactly the same as those Quarkus used to build the archive</p>
</li>
<li>
<p>The version of the JVM used to run the application must be <strong>exactly</strong> the same as the one used to build the Quarkus application.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Assuming we are using the same JVM to run the application as we used to build the application, we can launch the application like so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd target/quarkus-app
java -XX:SharedArchiveFile=app-cds.jsa -jar quarkus-run.jar</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The JVM is resilient. Faced with a situation where the archive file is not usable (for whatever reason) it will simply disable the AppCDS feature.</p>
</div>
<div class="paragraph">
<p>If it is desirable to simply halt the execution when the archive is not usable, the following command line invocation can be used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">java -Xshare:on -XX:SharedArchiveFile=app-cds.jsa -jar quarkus-run.jar</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Given what was mentioned above about how the application needs to be launched in order for the archive to be built, the question arises of how Quarkus deals with this situation.</p>
</div>
<div class="paragraph">
<p>The answer is that at application build time, right after the application archive is built, Quarkus launches the application, but only the parts of the launch process that are safe are run.
More specifically, the application is run up until the steps that actually open sockets or run application logic.</p>
</div>
<div class="paragraph">
<p>This results in an archive generation process that on one hand is completely safe, but on the other hand is unable to archive every single class that the application might need at boot time.
As a result, users are expected to get a slightly more effective archive if they manually go through the hoops of generating the AppCDS archive.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="usage-in-containers"><a class="anchor" href="#usage-in-containers"></a>Usage in containers</h3>
<div class="paragraph">
<p>When building container images using the <code>quarkus-container-image-jib</code> extension, Quarkus automatically takes care of all the steps needed to generate the archive
and make it usable at runtime in the container.</p>
</div>
<div class="paragraph">
<p>This way, by simply setting <code>quarkus.package.create-appcds</code> to <code>true</code> the generated container can benefit from a slight reduction in startup time and memory usage.</p>
</div>
</div>
</div>
</div>