<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Unresolved directive in _attributes.adoc - include::_attributes-local.adoc[]
:config-file: application.properties
:reactive-doc-url-prefix: <a href="https://hibernate.org/reactive/documentation/1.1/reference/html_single/#getting-started" class="bare">https://hibernate.org/reactive/documentation/1.1/reference/html_single/#getting-started</a></p>
</div>
<div class="paragraph">
<p><a href="https://hibernate.org/reactive/">Hibernate Reactive</a> is a reactive API for Hibernate ORM, supporting non-blocking database drivers
and a reactive style of interaction with the database.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Hibernate Reactive works with the same annotations and most of the configuration described in the
<a href="hibernate-orm">Hibernate ORM guide</a>. This guide will only focus on what&#8217;s specific
for Hibernate Reactive.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="solution"><a class="anchor" href="#solution"></a>Solution</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We recommend that you follow the instructions in the next sections and create the application step by step.
However, you can go right to the completed example.</p>
</div>
<div class="paragraph">
<p>Clone the Git repository: <code>git clone <a href="https://github.com/quarkusio/quarkus-quickstarts.git" class="bare">https://github.com/quarkusio/quarkus-quickstarts.git</a></code>, or download an <a href="https://github.com/quarkusio/quarkus-quickstarts/archive/main.zip">archive</a>.</p>
</div>
<div class="paragraph">
<p>The solution is located in the <code>hibernate-reactive-quickstart</code> <a href="https://github.com/quarkusio/quarkus-quickstarts/tree/main/hibernate-reactive-quickstart">directory</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="hr-getting-started"><a class="anchor" href="#hr-getting-started"></a>Setting up and configuring Hibernate Reactive</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When using Hibernate Reactive in Quarkus, you need to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>add your configuration settings in <code>{config-file}</code></p>
</li>
<li>
<p>annotate your entities with <code>@Entity</code> and any other mapping annotations as usual</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Other configuration needs have been automated: Quarkus will make some opinionated choices and educated guesses.</p>
</div>
<div class="paragraph">
<p>Add the following dependencies to your project:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the Hibernate Reactive extension: <code>io.quarkus:quarkus-hibernate-reactive</code></p>
</li>
<li>
<p>the <a href="reactive-sql-clients">Reactive SQL client extension</a> for the database of your choice; the following options are available:</p>
<div class="ulist">
<ul>
<li>
<p><code>quarkus-reactive-pg-client</code>: <a href="https://vertx.io/docs/vertx-pg-client/java">the client for PostgreSQL or CockroachDB</a></p>
</li>
<li>
<p><code>quarkus-reactive-mysql-client</code>: <a href="https://vertx.io/docs/vertx-mysql-client/java">the client MySQL or MariaDB</a></p>
</li>
<li>
<p><code>quarkus-reactive-mssql-client</code>: <a href="https://vertx.io/docs/vertx-mssql-client/java">the client for Microsoft SQL Server</a></p>
</li>
<li>
<p><code>quarkus-reactive-db2-client</code>: <a href="https://vertx.io/docs/vertx-db2-client/java">the client for IBM Db2</a></p>
</li>
<li>
<p><code>quarkus-reactive-oracle-client</code>: <a href="https://vertx.io/docs/vertx-oracle-client/java">the client for Oracle</a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>For instance:</p>
</div>
<div class="listingblock primary asciidoc-tabs-target-sync-cli asciidoc-tabs-target-sync-maven">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;!-- Hibernate Reactive dependency --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
    &lt;artifactId&gt;quarkus-hibernate-reactive&lt;/artifactId&gt;
&lt;/dependency&gt;

&lt;!-- Reactive SQL client for PostgreSQL --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
    &lt;artifactId&gt;quarkus-reactive-pg-client&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary asciidoc-tabs-target-sync-gradle">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gradle hljs" data-lang="gradle">// Hibernate Reactive dependency
implementation("io.quarkus:quarkus-hibernate-reactive")

Reactive SQL client for PostgreSQL
implementation("io.quarkus:quarkus-reactive-pg-client")</code></pre>
</div>
</div>
<div class="paragraph">
<p>Annotate your persistent objects with <code>@Entity</code>,
then add the relevant configuration properties in <code>{config-file}</code>:</p>
</div>
<div class="listingblock">
<div class="title">Example <code>{config-file}</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties"># datasource configuration
quarkus.datasource.db-kind = postgresql
quarkus.datasource.username = quarkus_test
quarkus.datasource.password = quarkus_test

quarkus.datasource.reactive.url = vertx-reactive:postgresql://localhost/quarkus_test <i class="conum" data-value="1"></i><b>(1)</b>

# drop and create the database at startup (use `update` to only update the schema)
quarkus.hibernate-orm.database.generation=drop-and-create</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The only different property from a Hibernate ORM configuration</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note that these configuration properties are not the same ones as in your typical Hibernate Reactive configuration file.
They will often map to Hibernate Reactive configuration properties but could have different names and don&#8217;t necessarily map 1:1 to each other.</p>
</div>
<div class="paragraph">
<p>Also, Quarkus will set many Hibernate Reactive configuration settings automatically, and will often use more modern defaults.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Configuring Hibernate Reactive using the standard <code>persistence.xml</code> configuration file is not supported.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>See section <a href="#hr-configuration-properties">Hibernate Reactive configuration properties</a> for the list of properties you can set in <code>{config-file}</code>.</p>
</div>
<div class="paragraph">
<p>A <code>Mutiny.SessionFactory</code> will be created based on the Quarkus <code>datasource</code> configuration as long as the Hibernate Reactive extension is listed among your project dependencies.</p>
</div>
<div class="paragraph">
<p>The dialect will be selected based on the Reactive SQL client - unless you set one explicitly.</p>
</div>
<div class="paragraph">
<p>You can then happily inject your <code>Mutiny.SessionFactory</code>:</p>
</div>
<div class="listingblock">
<div class="title">Example application bean using Hibernate Reactive</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ApplicationScoped
public class SantaClausService {
    @Inject
    Mutiny.SessionFactory sf; <i class="conum" data-value="1"></i><b>(1)</b>

    public Uni&lt;Void&gt; createGift(String giftDescription) {
	Gift gift = new Gift();
        gift.setName(giftDescription);
	return sf.withTransaction(session -&gt; session.persist(gift)) <i class="conum" data-value="2"></i><b>(2)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Inject your session factory and have fun</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>.withTransaction()</code> will automatically flush at commit</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Make sure to wrap methods modifying your database (e.g. <code>session.persist(entity)</code>) within a transaction.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Example of an Entity</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Entity
public class Gift {
    private Long id;
    private String name;

    @Id
    @SequenceGenerator(name = "giftSeq", sequenceName = "gift_id_seq", allocationSize = 1, initialValue = 1)
    @GeneratedValue(generator = "giftSeq")
    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To load SQL statements when Hibernate Reactive starts, add an <code>import.sql</code> file in your <code>src/main/resources/</code> directory.
This script can contain any SQL DML statements.
Make sure to terminate each statement with a semicolon.</p>
</div>
<div class="paragraph">
<p>This is useful to have a data set ready for your tests or demos.</p>
</div>
<div class="sect2">
<h3 id="hr-configuration-properties"><a class="anchor" href="#hr-configuration-properties"></a>Hibernate Reactive configuration properties</h3>
<div class="paragraph">
<p>There are various optional properties useful to refine your session factory or guide Quarkus' guesses.</p>
</div>
<div class="paragraph">
<p>When no properties are set, Quarkus can typically infer everything it needs to set up Hibernate Reactive
and will have it use the default datasource.</p>
</div>
<div class="paragraph">
<p>The configuration properties listed here allow you to override such defaults, and customize and tune various aspects.</p>
</div>
<div class="paragraph">
<p>Hibernate Reactive uses the same properties you would use for Hibernate ORM. You will notice that some properties
contain <code>jdbc</code> in the name but there is not JDBC in Hibernate Reactive, these are simply legacy property names.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Want to start a PostgreSQL server on the side with Docker?</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">docker run --rm --name postgres-quarkus-hibernate -e POSTGRES_USER=quarkus_test \
           -e POSTGRES_PASSWORD=quarkus_test -e POSTGRES_DB=quarkus_test \
           -p 5432:5432 postgres:14.1</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will start a non-durable empty database: ideal for a quick experiment!</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="hr-cdi-integration"><a class="anchor" href="#hr-cdi-integration"></a>CDI integration</h4>
<div class="paragraph">
<p>If you are familiar with using Hibernate Reactive in Quarkus, you probably already have injected the <code>Mutiny.SessionFactory</code> using CDI:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Inject
Mutiny.SessionFactory sessionFactory;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will inject the <code>Mutiny.SessionFactory</code> of the default persistence unit.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Prior to Quarkus 3.0 it was also possible to inject a <code>@RequestScoped</code> bean for <code>Mutiny.Session</code>. However, the lifecycle of a reactive session does not fit the lifecycle of the CDI request context. Therefore, this bean is removed in Quarkus 3.0.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="testing"><a class="anchor" href="#testing"></a>Testing</h3>
<div class="paragraph">
<p>Using Hibernate Reactive in a <code>@QuarkusTest</code> is slightly more involved than using Hibernate ORM due to the asynchronous nature of the APIs and the fact that all operations need to run on a Vert.x Event Loop.</p>
</div>
<div class="paragraph">
<p>Two components are necessary to write these tests:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The use of <code>@io.quarkus.test.vertx.RunOnVertxContext</code> or <code>@io.quarkus.test.TestReactiveTransaction</code> on the test methods</p>
</li>
<li>
<p>The use of <code>io.quarkus.test.vertx.UniAsserter</code> as a test method parameter.</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
These classes are provided by the <code>quarkus-test-vertx</code> dependency.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A very simple example usage looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@QuarkusTest
public class SomeTest {

    @Inject
    Mutiny.SessionFactory sessionFactory;

    @Test
    @RunOnVertxContext
    public void testQuery(UniAsserter asserter) {
        asserter.assertThat(() -&gt; sessionFactory.withSession(s -&gt; s.createQuery(
                "from Gift g where g.name = :name").setParameter("name", "Lego").getResultList()),
                list -&gt; org.junit.jupiter.api.Assertions.assertEquals(list.size(), 1));
    }

}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
See the Javadoc of <code>UniAsserter</code> for a full description of the various methods that can be used for creating assertions.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You can also extend the <code>io.quarkus.test.vertx.UniAsserterInterceptor</code> to wrap the injected <code>UniAsserter</code> and customize the default behavior. For example, the interceptor can be used to execute the assert methods within a separate database transaction.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@QuarkusTest
public class SomeTest {

   @Test
   @RunOnVertxContext
   public void testEntity(UniAsserter asserter) {
      asserter = new UniAsserterInterceptor(asserter) {
         @Override
         protected &lt;T&gt; Supplier&lt;Uni&lt;T&gt;&gt; transformUni(Supplier&lt;Uni&lt;T&gt;&gt; uniSupplier) {
            return () -&gt; Panache.withTransaction(uniSupplier);
         }
      };
      asserter.execute(() -&gt; new MyEntity().persist());
      asserter.assertEquals(() -&gt; MyEntity.count(), 1l);
      asserter.execute(() -&gt; MyEntity.deleteAll());
   }
}</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="hr-limitations"><a class="anchor" href="#hr-limitations"></a>Limitations and other things you should know</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Quarkus does not modify the libraries it uses; this rule applies to Hibernate Reactive as well: when using
this extension you will mostly have the same experience as using the original library.</p>
</div>
<div class="paragraph">
<p>But while they share the same code, Quarkus does configure some components automatically and inject custom implementations
for some extension points; this should be transparent and useful but if you&#8217;re an expert of Hibernate Reactive you might want to
know what is being done.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s a list of things to pay attention when using Hibernate Reactive in Quarkus:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>it&#8217;s not possible to configure multiple persistence units at the moment</p>
</li>
<li>
<p>it&#8217;s not configurable via a <code>persistence.xml</code> file</p>
</li>
<li>
<p>integration with the Envers extension is not supported</p>
</li>
<li>
<p>transaction demarcation cannot be done using <code>jakarta.transaction.Transactional</code></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="simplifying-hibernate-reactive-with-panache"><a class="anchor" href="#simplifying-hibernate-reactive-with-panache"></a>Simplifying Hibernate Reactive with Panache</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <a href="hibernate-reactive-panache">Hibernate Reactive with Panache</a> extension facilitates the usage of Hibernate Reactive
by providing active record style entities (and repositories) and focuses on making your entities trivial and fun to write in Quarkus.</p>
</div>
</div>
</div>