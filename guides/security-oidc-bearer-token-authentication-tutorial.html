<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Here, you use the Quarkus OpenID Connect (OIDC) extension to secure a Jakarta REST application using Bearer token authentication.
The bearer tokens are issued by OIDC and OAuth 2.0 compliant authorization servers, such as <a href="https://www.keycloak.org">Keycloak</a>.</p>
</div>
<div class="paragraph">
<p>To better understand OIDC Bearer token authentication, see <a href="security-oidc-bearer-token-authentication">OIDC Bearer token authentication</a>.</p>
</div>
<div class="paragraph">
<p>If you want to protect web applications by using OIDC Authorization Code Flow authentication, see <a href="security-oidc-code-flow-authentication-concept">OIDC authorization code flow authentication</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="prerequisites"><a class="anchor" href="#prerequisites"></a>Prerequisites</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Unresolved directive in security-oidc-bearer-token-authentication-tutorial.adoc - include::{includes}/prerequisites.adoc[]
* <a href="https://stedolan.github.io/jq/">jq tool</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="architecture"><a class="anchor" href="#architecture"></a>Architecture</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this example, we build a simple microservice which offers two endpoints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>/api/users/me</code></p>
</li>
<li>
<p><code>/api/admin</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These endpoints are protected and can only be accessed if a client is sending a bearer token along with the request, which must be valid (e.g.: signature, expiration and audience) and trusted by the microservice.</p>
</div>
<div class="paragraph">
<p>The bearer token is issued by a Keycloak Server and represents the subject to which the token was issued for. For being an OAuth 2.0 Authorization Server, the token also references the client acting on behalf of the user.</p>
</div>
<div class="paragraph">
<p>The <code>/api/users/me</code> endpoint can be accessed by any user with a valid token. As a response, it returns a JSON document with details about the user where these details are obtained from the information carried on the token.</p>
</div>
<div class="paragraph">
<p>The <code>/api/admin</code> endpoint is protected with RBAC (Role-Based Access Control) where only users granted with the <code>admin</code> role can access. At this endpoint, we use the <code>@RolesAllowed</code> annotation to declaratively enforce the access constraint.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="solution"><a class="anchor" href="#solution"></a>Solution</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We recommend that you follow the instructions in the next sections and create the application step by step.
However, you can go right to the completed example.</p>
</div>
<div class="paragraph">
<p>Clone the Git repository: <code>git clone <a href="https://github.com/quarkusio/quarkus-quickstarts.git" class="bare">https://github.com/quarkusio/quarkus-quickstarts.git</a></code>, or download an <a href="https://github.com/quarkusio/quarkus-quickstarts/archive/main.zip">archive</a>.</p>
</div>
<div class="paragraph">
<p>The solution is located in the <code>security-openid-connect-quickstart</code> <a href="https://github.com/quarkusio/quarkus-quickstarts/tree/main/security-openid-connect-quickstart">directory</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="procedure"><a class="anchor" href="#procedure"></a>Procedure</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="create-the-maven-project"><a class="anchor" href="#create-the-maven-project"></a>Create the Maven project</h3>
<div class="paragraph">
<p>First, we need a new project. Create a new project with the following command:</p>
</div>
<div class="paragraph">
<p>Unresolved directive in security-oidc-bearer-token-authentication-tutorial.adoc - include::{includes}/devtools/create-app.adoc[]</p>
</div>
<div class="paragraph">
<p>This command generates a Maven project, importing the <code>oidc</code> extension
which is an implementation of OIDC for Quarkus.</p>
</div>
<div class="paragraph">
<p>If you already have your Quarkus project configured, you can add the <code>oidc</code> extension
to your project by running the following command in your project base directory:</p>
</div>
<div class="paragraph">
<p>Unresolved directive in security-oidc-bearer-token-authentication-tutorial.adoc - include::{includes}/devtools/extension-add.adoc[]</p>
</div>
<div class="paragraph">
<p>This will add the following to your build file:</p>
</div>
<div class="listingblock primary asciidoc-tabs-target-sync-cli asciidoc-tabs-target-sync-maven">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
    &lt;artifactId&gt;quarkus-oidc&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary asciidoc-tabs-target-sync-gradle">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gradle hljs" data-lang="gradle">implementation("io.quarkus:quarkus-oidc")</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="write-the-application"><a class="anchor" href="#write-the-application"></a>Write the application</h3>
<div class="paragraph">
<p>Let&#8217;s start by implementing the <code>/api/users/me</code> endpoint. As you can see from the source code below it is just a regular Jakarta REST resource:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme.security.openid.connect;

import jakarta.annotation.security.RolesAllowed;
import jakarta.inject.Inject;
import jakarta.ws.rs.GET;
import jakarta.ws.rs.Path;

import org.jboss.resteasy.reactive.NoCache;
import io.quarkus.security.identity.SecurityIdentity;

@Path("/api/users")
public class UsersResource {

    @Inject
    SecurityIdentity securityIdentity;

    @GET
    @Path("/me")
    @RolesAllowed("user")
    @NoCache
    public User me() {
        return new User(securityIdentity);
    }

    public static class User {

        private final String userName;

        User(SecurityIdentity securityIdentity) {
            this.userName = securityIdentity.getPrincipal().getName();
        }

        public String getUserName() {
            return userName;
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The source code for the <code>/api/admin</code> endpoint is also very simple. The main difference here is that we are using a <code>@RolesAllowed</code> annotation to make sure that only users granted with the <code>admin</code> role can access the endpoint:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme.security.openid.connect;

import jakarta.annotation.security.RolesAllowed;
import jakarta.ws.rs.GET;
import jakarta.ws.rs.Path;
import jakarta.ws.rs.Produces;
import jakarta.ws.rs.core.MediaType;

@Path("/api/admin")
public class AdminResource {

    @GET
    @RolesAllowed("admin")
    @Produces(MediaType.TEXT_PLAIN)
    public String admin() {
        return "granted";
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Injection of the <code>SecurityIdentity</code> is supported in both <code>@RequestScoped</code> and <code>@ApplicationScoped</code> contexts.</p>
</div>
</div>
<div class="sect2">
<h3 id="configure-the-application"><a class="anchor" href="#configure-the-application"></a>Configure the application</h3>
<div class="paragraph">
<p>Configure the Quarkus OpenID Connect (OIDC) extension by setting the following configuration properties in the <code>src/main/resources/application.properties</code> file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">%prod.quarkus.oidc.auth-server-url=http://localhost:8180/realms/quarkus
quarkus.oidc.client-id=backend-service
quarkus.oidc.credentials.secret=secret

# Tell Dev Services for Keycloak to import the realm file
# This property is not effective when running the application in JVM or Native modes

quarkus.keycloak.devservices.realm-path=quarkus-realm.json</code></pre>
</div>
</div>
<div class="paragraph">
<p>Where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>%prod.quarkus.oidc.auth-server-url</code> sets the base URL of the OpenID Connect (OIDC) server. The <code>%prod.</code> profile prefix ensures that <code>Dev Services for Keycloak</code> launches a container when you run the application in dev mode.
See <a href="#keycloak-dev-mode">Running the Application in Dev mode</a> section below for more information.</p>
</li>
<li>
<p><code>quarkus.oidc.client-id</code> sets a client-id that identifies the application.</p>
</li>
<li>
<p><code>quarkus.oidc.credentials.secret</code> sets the client secret, which is used by the <code>client_secret_basic</code> authentication method.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For more information, see <a href="security-openid-connect-oidc-configuration-properties-reference">OpenID Connect (OIDC) configuration properties</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="start-and-configure-the-keycloak-server"><a class="anchor" href="#start-and-configure-the-keycloak-server"></a>Start and configure the Keycloak server</h3>
<div class="paragraph">
<p>Before you start with configuration, put the <a href="https://github.com/quarkusio/quarkus-quickstarts/tree/main/security-openid-connect-quickstart/config/quarkus-realm.json">realm configuration file</a> on the classpath (<code>target/classes</code> directory) to import it automatically when running in dev mode - unless you have already built a <a href="https://github.com/quarkusio/quarkus-quickstarts/tree/main/security-openid-connect-quickstart">complete solution</a>.
In this case, the realm file is added to the classpath during the build.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Do not start the Keycloak server when you run the application in a dev mode - <code>Dev Services for Keycloak</code> will launch a container.
See the <a href="#keycloak-dev-mode">Running the Application in Dev mode</a> section below for more information.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To start a Keycloak Server, you can use Docker and just run the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">docker run --name keycloak -e KEYCLOAK_ADMIN=admin -e KEYCLOAK_ADMIN_PASSWORD=admin -p 8180:8080 quay.io/keycloak/keycloak:{keycloak.version} start-dev</code></pre>
</div>
</div>
<div class="paragraph">
<p>where <code>keycloak.version</code> should be set to <code>17.0.0</code> or higher.</p>
</div>
<div class="paragraph">
<p>You should be able to access your Keycloak Server at <a href="http://localhost:8180">localhost:8180</a>.</p>
</div>
<div class="paragraph">
<p>Log in as the <code>admin</code> user to access the Keycloak Administration Console. Username should be <code>admin</code> and password <code>admin</code>.</p>
</div>
<div class="paragraph">
<p>Import the <a href="https://github.com/quarkusio/quarkus-quickstarts/tree/main/security-openid-connect-quickstart/config/quarkus-realm.json">realm configuration file</a> to create a new realm.
For more details, see the Keycloak documentation about how to <a href="https://www.keycloak.org/docs/latest/server_admin/index.html#_create-realm">create a new realm</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you want to use the Keycloak Admin Client to configure your server from your application, include the
either <code>quarkus-keycloak-admin-client</code> or the <code>quarkus-keycloak-admin-client-reactive</code> (if the application uses <code>quarkus-rest-client-reactive</code>) extension.
See the <a href="security-keycloak-admin-client">Quarkus Keycloak Admin Client</a> guide for more information.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="keycloak-dev-mode"><a class="anchor" href="#keycloak-dev-mode"></a>Run the application in Dev mode</h3>
<div class="paragraph">
<p>To run the application in a dev mode, use:</p>
</div>
<div class="paragraph">
<p>Unresolved directive in security-oidc-bearer-token-authentication-tutorial.adoc - include::{includes}/devtools/dev.adoc[]</p>
</div>
<div class="paragraph">
<p><a href="security-openid-connect-dev-services">Dev Services for Keycloak</a> will launch a Keycloak container and import a <code>quarkus-realm.json</code>.</p>
</div>
<div class="paragraph">
<p>Open a <a href="dev-ui">Dev UI</a> available at <a href="http://localhost:8080/q/dev-v1">/q/dev-v1</a> and click on a <code>Provider: Keycloak</code> link in an <code>OpenID Connect</code> <code>Dev UI</code> card.</p>
</div>
<div class="paragraph">
<p>You will be asked to log in into a <code>Single Page Application</code> provided by <code>OpenID Connect Dev UI</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Login as <code>alice</code> (password: <code>alice</code>) who has a <code>user</code> role</p>
<div class="ulist">
<ul>
<li>
<p>accessing <code>/api/admin</code> will return <code>403</code></p>
</li>
<li>
<p>accessing <code>/api/users/me</code> will return <code>200</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Logout and login as <code>admin</code> (password: <code>admin</code>) who has both <code>admin</code> and <code>user</code> roles</p>
<div class="ulist">
<ul>
<li>
<p>accessing <code>/api/admin</code> will return <code>200</code></p>
</li>
<li>
<p>accessing <code>/api/users/me</code> will return <code>200</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="run-the-application-in-jvm-mode"><a class="anchor" href="#run-the-application-in-jvm-mode"></a>Run the Application in JVM mode</h3>
<div class="paragraph">
<p>When you&#8217;re done playing with the <code>dev</code> mode" you can run it as a standard Java application.</p>
</div>
<div class="paragraph">
<p>First compile it:</p>
</div>
<div class="paragraph">
<p>Unresolved directive in security-oidc-bearer-token-authentication-tutorial.adoc - include::{includes}/devtools/build.adoc[]</p>
</div>
<div class="paragraph">
<p>Then run it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">java -jar target/quarkus-app/quarkus-run.jar</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="run-the-application-in-native-mode"><a class="anchor" href="#run-the-application-in-native-mode"></a>Run the application in Native mode</h3>
<div class="paragraph">
<p>This same demo can be compiled into native code: no modifications required.</p>
</div>
<div class="paragraph">
<p>This implies that you no longer need to install a JVM on your production environment, as the runtime technology is included in the produced binary, and optimized to run with minimal resource overhead.</p>
</div>
<div class="paragraph">
<p>Compilation will take a bit longer, so this step is disabled by default;
let&#8217;s build again by enabling the <code>native</code> profile:</p>
</div>
<div class="paragraph">
<p>Unresolved directive in security-oidc-bearer-token-authentication-tutorial.adoc - include::{includes}/devtools/build-native.adoc[]</p>
</div>
<div class="paragraph">
<p>After getting a cup of coffee, you&#8217;ll be able to run this binary directly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./target/security-openid-connect-quickstart-1.0.0-SNAPSHOT-runner</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="test-the-application"><a class="anchor" href="#test-the-application"></a>Test the application</h3>
<div class="paragraph">
<p>See the <a href="#keycloak-dev-mode">Running the Application in Dev mode</a> section above about testing your application in a dev mode.</p>
</div>
<div class="paragraph">
<p>You can test the application launched in JVM or Native modes with <code>curl</code>.</p>
</div>
<div class="paragraph">
<p>The application is using Bearer token authentication and the first thing to do is obtain an access token from the Keycloak Server in order to access the application resources:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export access_token=$(\
    curl --insecure -X POST http://localhost:8180/realms/quarkus/protocol/openid-connect/token \
    --user backend-service:secret \
    -H 'content-type: application/x-www-form-urlencoded' \
    -d 'username=alice&amp;password=alice&amp;grant_type=password' | jq --raw-output '.access_token' \
 )</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example above obtains an access token for user <code>alice</code>.</p>
</div>
<div class="paragraph">
<p>Any user is allowed to access the <code><a href="http://localhost:8080/api/users/me" class="bare">http://localhost:8080/api/users/me</a></code> endpoint, which basically returns a JSON payload with details about the user.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -v -X GET \
  http://localhost:8080/api/users/me \
  -H "Authorization: Bearer "$access_token</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code><a href="http://localhost:8080/api/admin" class="bare">http://localhost:8080/api/admin</a></code> endpoint can only be accessed by users with the <code>admin</code> role.
If you try to access this endpoint with the previously issued access token, you should get a <code>403</code> response from the server.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -v -X GET \
   http://localhost:8080/api/admin \
   -H "Authorization: Bearer "$access_token</code></pre>
</div>
</div>
<div class="paragraph">
<p>In order to access the admin endpoint, you should obtain a token for the <code>admin</code> user:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export access_token=$(\
    curl --insecure -X POST http://localhost:8180/realms/quarkus/protocol/openid-connect/token \
    --user backend-service:secret \
    -H 'content-type: application/x-www-form-urlencoded' \
    -d 'username=admin&amp;password=admin&amp;grant_type=password' | jq --raw-output '.access_token' \
 )</code></pre>
</div>
</div>
<div class="paragraph">
<p>Please also see the <a href="security-oidc-bearer-token-authentication#integration-testing-keycloak-devservices">OIDC Bearer token authentication, Dev Services for Keycloak</a> section, about writing the integration tests which depend on <code>Dev Services for Keycloak</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="references"><a class="anchor" href="#references"></a>References</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="security-oidc-configuration-properties-reference">OIDC configuration properties</a></p>
</li>
<li>
<p><a href="security-oidc-bearer-token-authentication">OIDC Bearer token authentication</a></p>
</li>
<li>
<p><a href="https://www.keycloak.org/documentation.html">Keycloak Documentation</a></p>
</li>
<li>
<p><a href="https://openid.net/connect/">OpenID Connect</a></p>
</li>
<li>
<p><a href="https://tools.ietf.org/html/rfc7519">JSON Web Token</a></p>
</li>
<li>
<p><a href="security-openid-connect-client-reference">OpenID Connect and OAuth2 Client and Filters Reference Guide</a></p>
</li>
<li>
<p><a href="security-openid-connect-dev-services">Dev Services for Keycloak</a></p>
</li>
<li>
<p><a href="security-jwt-build">Sign and encrypt JWT tokens with SmallRye JWT Build</a></p>
</li>
<li>
<p><a href="security-authentication-mechanisms#combining-authentication-mechanisms">Combining authentication mechanisms</a></p>
</li>
<li>
<p><a href="security-overview">Quarkus Security</a></p>
</li>
<li>
<p><a href="security-keycloak-admin-client">Quarkus Keycloak Admin Client</a></p>
</li>
</ul>
</div>
</div>
</div>