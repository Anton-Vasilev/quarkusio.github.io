<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This guide explains how your Quarkus application can utilize OpenTracing to provide distributed tracing for
interactive web applications.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p><a href="opentelemetry">OpenTelemetry</a> is the recommended approach to tracing and telemetry for Quarkus.</p>
</div>
<div class="paragraph">
<p>When Quarkus will upgrade to Eclipse MicroProfile 6, the SmallRye OpenTracing support will be discontinued.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Unresolved directive in opentracing.adoc - include::{includes}/extension-status.adoc[]</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="prerequisites"><a class="anchor" href="#prerequisites"></a>Prerequisites</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Unresolved directive in opentracing.adoc - include::{includes}/prerequisites.adoc[]</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="architecture"><a class="anchor" href="#architecture"></a>Architecture</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this guide, we create a straightforward REST application to demonstrate distributed tracing.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="solution"><a class="anchor" href="#solution"></a>Solution</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We recommend that you follow the instructions in the next sections and create the application step by step.
However, you can skip right to the completed example.</p>
</div>
<div class="paragraph">
<p>Clone the Git repository: <code>git clone <a href="https://github.com/quarkusio/quarkus-quickstarts.git" class="bare">https://github.com/quarkusio/quarkus-quickstarts.git</a></code>, or download an <a href="https://github.com/quarkusio/quarkus-quickstarts/archive/main.zip">archive</a>.</p>
</div>
<div class="paragraph">
<p>The solution is located in the <code>opentracing-quickstart</code> <a href="https://github.com/quarkusio/quarkus-quickstarts/tree/main/opentracing-quickstart">directory</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="creating-the-maven-project"><a class="anchor" href="#creating-the-maven-project"></a>Creating the Maven project</h2>
<div class="sectionbody">
<div class="paragraph">
<p>First, we need a new project. Create a new project with the following command:</p>
</div>
<div class="paragraph">
<p>Unresolved directive in opentracing.adoc - include::{includes}/devtools/create-app.adoc[]</p>
</div>
<div class="paragraph">
<p>This command generates the Maven project and imports the <code>smallrye-opentracing</code> extension, which
includes the OpenTracing support and the default <a href="https://www.jaegertracing.io/">Jaeger</a> tracer.</p>
</div>
<div class="paragraph">
<p>If you already have your Quarkus project configured, you can add the <code>smallrye-opentracing</code> extension
to your project by running the following command in your project base directory:</p>
</div>
<div class="paragraph">
<p>Unresolved directive in opentracing.adoc - include::{includes}/devtools/extension-add.adoc[]</p>
</div>
<div class="paragraph">
<p>This will add the following to your build file:</p>
</div>
<div class="listingblock primary asciidoc-tabs-target-sync-cli asciidoc-tabs-target-sync-maven">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
    &lt;artifactId&gt;quarkus-smallrye-opentracing&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary asciidoc-tabs-target-sync-gradle">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gradle hljs" data-lang="gradle">implementation("io.quarkus:quarkus-smallrye-opentracing")</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="examine-the-jakarta-rest-resource"><a class="anchor" href="#examine-the-jakarta-rest-resource"></a>Examine the Jakarta REST resource</h3>
<div class="paragraph">
<p>Create the <code>src/main/java/org/acme/opentracing/TracedResource.java</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme.opentracing;

import jakarta.ws.rs.GET;
import jakarta.ws.rs.Path;
import jakarta.ws.rs.Produces;
import jakarta.ws.rs.core.MediaType;
import org.jboss.logging.Logger;

@Path("/hello")
public class TracedResource {

    private static final Logger LOG = Logger.getLogger(TracedResource.class);

    @GET
    @Produces(MediaType.TEXT_PLAIN)
    public String hello() {
        LOG.info("hello"); <i class="conum" data-value="1"></i><b>(1)</b>
        return "hello";
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The log event carries OpenTracing information as well. In order to print OpenTracing information to the console output, the console log handler with the required OpenTracing event&#8217;s keys needs to be defined in the <code>application.properties</code> file.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Notice that there is no tracing specific code included in the application. By default, requests sent to this
endpoint will be traced without any code changes being required. It is also possible to enhance the tracing information.
This can be achieved by <a href="https://github.com/smallrye/smallrye-opentracing/">SmallRye OpenTracing</a> an implementation of
<a href="https://github.com/eclipse/microprofile-opentracing/">MicroProfile OpenTracing</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="create-the-configuration"><a class="anchor" href="#create-the-configuration"></a>Create the configuration</h3>
<div class="paragraph">
<p>There are two ways to configure the Jaeger tracer within the application.</p>
</div>
<div class="paragraph">
<p>The first approach is by providing the properties within the <code>src/main/resources/application.properties</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.jaeger.service-name=myservice <i class="conum" data-value="1"></i><b>(1)</b>
quarkus.jaeger.sampler-type=const <i class="conum" data-value="2"></i><b>(2)</b>
quarkus.jaeger.sampler-param=1 <i class="conum" data-value="3"></i><b>(3)</b>
quarkus.log.console.format=%d{HH:mm:ss} %-5p traceId=%X{traceId}, parentId=%X{parentId}, spanId=%X{spanId}, sampled=%X{sampled} [%c{2.}] (%t) %s%e%n <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>If the <code>quarkus.jaeger.service-name</code> property (or <code>JAEGER_SERVICE_NAME</code> environment variable) is not provided then a "no-op" tracer will be configured, resulting in no tracing data being reported to the backend.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set up a sampler that uses a constant sampling strategy.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Sample all requests. Set sampler-param to somewhere between 0 and 1, e.g. 0.50, if you do not wish to sample all requests.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Add trace IDs into log message.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The second approach is to supply the properties as <a href="https://www.jaegertracing.io/docs/latest/client-features/">environment variables</a>. These can be specified using <code>jvm.args</code> as shown in the following section.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="run-the-application"><a class="anchor" href="#run-the-application"></a>Run the application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The first step is to start the tracing system to collect and display the captured traces:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">docker run -p 5775:5775/udp -p 6831:6831/udp -p 6832:6832/udp -p 5778:5778 -p 16686:16686 -p 14268:14268 jaegertracing/all-in-one:latest</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we are ready to run our application. If using <code>application.properties</code> to configure the tracer:</p>
</div>
<div class="paragraph">
<p>Unresolved directive in opentracing.adoc - include::{includes}/devtools/dev.adoc[]</p>
</div>
<div class="paragraph">
<p>or if configuring the tracer via environment variables:</p>
</div>
<div class="paragraph">
<p>Unresolved directive in opentracing.adoc - include::{includes}/devtools/dev.adoc[]
:!dev-additional-parameters:</p>
</div>
<div class="paragraph">
<p>Once both the application and tracing system are started, you can make a request to the provided endpoint:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ curl http://localhost:8080/hello
hello</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the first request has been submitted, the Jaeger tracer within the app will be initialized:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">2019-10-16 09:35:23,464 INFO  [io.jae.Configuration] (executor-thread-1) Initialized tracer=JaegerTracer(version=Java-0.34.0, serviceName=myservice, reporter=RemoteReporter(sender=UdpSender(), closeEnqueueTimeout=1000), sampler=ConstSampler(decision=true, tags={sampler.type=const, sampler.param=true}), tags={hostname=localhost.localdomain, jaeger.version=Java-0.34.0, ip=127.0.0.1}, zipkinSharedRpcSpan=false, expandExceptionLogs=false, useTraceId128Bit=false)
13:20:11 INFO  traceId=1336b2b0a76a96a3, parentId=0, spanId=1336b2b0a76a96a3, sampled=true [or.ac.qu.TracedResource] (executor-thread-63) hello</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then visit the <a href="http://localhost:16686">Jaeger UI</a> to see the tracing information.</p>
</div>
<div class="paragraph">
<p>Hit <code>CTRL+C</code> to stop the application.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="tracing-additional-methods"><a class="anchor" href="#tracing-additional-methods"></a>Tracing additional methods</h2>
<div class="sectionbody">
<div class="paragraph">
<p>REST endpoints are automatically traced.
If you need to trace additional methods, you can add the <code>org.eclipse.microprofile.opentracing.Traced</code> annotation to CDI bean classes or their non-private methods.</p>
</div>
<div class="paragraph">
<p>This can be useful to trace incoming requests from non-REST calls (like request coming from a message) or to create spans inside a trace.</p>
</div>
<div class="paragraph">
<p>Here is an example of a <code>FrancophoneService</code> which methods are traced.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import jakarta.enterprise.context.ApplicationScoped;

import org.eclipse.microprofile.opentracing.Traced;

@Traced
@ApplicationScoped
public class FrancophoneService {

    public String bonjour() {
        return "bonjour";
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The best way to add OpenTracing capability to reactive messaging based applications is by adding the <code>Traced</code> annotation to all incoming methods.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="additional-instrumentation"><a class="anchor" href="#additional-instrumentation"></a>Additional instrumentation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <a href="https://github.com/opentracing-contrib">OpenTracing API Contributions project</a> offers additional instrumentation that can be used to add tracing to a large variety of technologies/components.</p>
</div>
<div class="paragraph">
<p>The instrumentation documented in this section has been tested with Quarkus and works in both standard and native mode.</p>
</div>
<div class="sect2">
<h3 id="jdbc"><a class="anchor" href="#jdbc"></a>JDBC</h3>
<div class="paragraph">
<p>The <a href="https://github.com/opentracing-contrib/java-jdbc">JDBC instrumentation</a> will add a span for each JDBC queries done by your application, to enable it, add the following dependency to your build file:</p>
</div>
<div class="listingblock primary asciidoc-tabs-target-sync-cli asciidoc-tabs-target-sync-maven">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.opentracing.contrib&lt;/groupId&gt;
    &lt;artifactId&gt;opentracing-jdbc&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary asciidoc-tabs-target-sync-gradle">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gradle hljs" data-lang="gradle">implementation("io.opentracing.contrib:opentracing-jdbc")</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, you need to enable it in the configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.datasource.jdbc.tracing=true</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>quarkus.datasource.jdbc.tracing</code> is a build time configuration property:
it makes sure all the tracing infrastructure is included in your application.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This is especially important when building a native executable as we need to
make sure the OpenTracing JDBC driver has been registered for reflection,
together with the underlying JDBC driver.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The Agroal extension will take care of adjusting the JDBC URL with the <code>tracing</code> prefix
when tracing is enabled,
so you do not have to adjust the JDBC URL yourself.</p>
</div>
<div class="paragraph">
<p>By default, when <code>quarkus.datasource.jdbc.tracing</code> is true, tracing is enabled at runtime
but you can explicitly disable it by setting the following property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.datasource.jdbc.tracing.enabled=false</code></pre>
</div>
</div>
<div class="paragraph">
<p>This way, you can have your Quarkus application ready for tracing and toggle JDBC tracing at runtime.</p>
</div>
</div>
<div class="sect2">
<h3 id="kafka"><a class="anchor" href="#kafka"></a>Kafka</h3>
<div class="paragraph">
<p>The <a href="https://github.com/opentracing-contrib/java-kafka-client">Kafka instrumentation</a> will add a span for each message sent to or received from a Kafka topic. To enable it, add the following dependency to your build file:</p>
</div>
<div class="listingblock primary asciidoc-tabs-target-sync-cli asciidoc-tabs-target-sync-maven">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.opentracing.contrib&lt;/groupId&gt;
    &lt;artifactId&gt;opentracing-kafka-client&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary asciidoc-tabs-target-sync-gradle">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gradle hljs" data-lang="gradle">implementation("io.opentracing.contrib:opentracing-kafka-client")</code></pre>
</div>
</div>
<div class="paragraph">
<p>It contains OpenTracing interceptors that must be registered on Kafka producers and consumers.</p>
</div>
<div class="paragraph">
<p>If you followed the <a href="kafka">Kafka guide</a>, the interceptors can be added on the <code>generated-price</code> and the <code>prices</code> channels as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties"># Configure the Kafka sink (we write to it)
mp.messaging.outgoing.generated-price.connector=smallrye-kafka
mp.messaging.outgoing.generated-price.topic=prices
mp.messaging.outgoing.generated-price.value.serializer=org.apache.kafka.common.serialization.IntegerSerializer
mp.messaging.outgoing.generated-price.interceptor.classes=io.opentracing.contrib.kafka.TracingProducerInterceptor

# Configure the Kafka source (we read from it)
mp.messaging.incoming.prices.connector=smallrye-kafka
mp.messaging.incoming.prices.value.deserializer=org.apache.kafka.common.serialization.IntegerDeserializer
mp.messaging.incoming.prices.interceptor.classes=io.opentracing.contrib.kafka.TracingConsumerInterceptor</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>interceptor.classes</code> accept a list of classes separated by a comma.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="mongodb-client"><a class="anchor" href="#mongodb-client"></a>MongoDB client</h3>
<div class="paragraph">
<p>The <a href="https://github.com/opentracing-contrib/java-mongo-driver">Mongo Driver instrumentation</a> will add a span for each command executed by your application. To enable it, add the following dependency to your build file:</p>
</div>
<div class="listingblock primary asciidoc-tabs-target-sync-cli asciidoc-tabs-target-sync-maven">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.opentracing.contrib&lt;/groupId&gt;
    &lt;artifactId&gt;opentracing-mongo-common&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary asciidoc-tabs-target-sync-gradle">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gradle hljs" data-lang="gradle">implementation("io.opentracing.contrib:opentracing-mongo-common")</code></pre>
</div>
</div>
<div class="paragraph">
<p>It contains the OpenTracing CommandListener that will be registered on the configuration of the mongo client.
Following the <a href="mongodb">MongoDB guide</a>, the command listener will be registered defining the config property as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties"># Enable tracing commands in mongodb client
quarkus.mongodb.tracing.enabled=true</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="zipkin-compatibility-mode"><a class="anchor" href="#zipkin-compatibility-mode"></a>Zipkin compatibility mode</h3>
<div class="paragraph">
<p>To enable it, add the following dependency to your build file:</p>
</div>
<div class="listingblock primary asciidoc-tabs-target-sync-cli asciidoc-tabs-target-sync-maven">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.jaegertracing&lt;/groupId&gt;
    &lt;artifactId&gt;jaeger-zipkin&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary asciidoc-tabs-target-sync-gradle">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gradle hljs" data-lang="gradle">implementation("io.jaegertracing:jaeger-zipkin")</code></pre>
</div>
</div>
<div class="paragraph">
<p>It contains the dependencies to convert the request to zipkin format.
The zipkin compatibility mode will be activated after defining the config property as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties"># Enable zipkin compatibility mode
quarkus.jaeger.zipkin.compatibility-mode=true</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuration-reference"><a class="anchor" href="#configuration-reference"></a>Jaeger Configuration Reference</h2>
<div class="sectionbody">

</div>
</div>