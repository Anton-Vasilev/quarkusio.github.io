<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Unresolved directive in _attributes.adoc - include::_attributes-local.adoc[]
:change-log: src/main/resources/db/changeLog.xml
:config-file: application.properties</p>
</div>
<div class="paragraph">
<p><a href="https://www.liquibase.org/">Liquibase</a> is an open source tool for database schema change management,
it allows managing MongoDB databases via it&#8217;s <a href="https://github.com/liquibase/liquibase-mongodb">MongoDB Extension</a>.</p>
</div>
<div class="paragraph">
<p>Quarkus provides first class support for using Liquibase MongoDB Extension as will be explained in this guide.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="solution"><a class="anchor" href="#solution"></a>Solution</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We recommend that you follow the instructions in the next sections and create the application step by step.
However, you can go right to the completed example.</p>
</div>
<div class="paragraph">
<p>Clone the Git repository: <code>git clone <a href="https://github.com/quarkusio/quarkus-quickstarts.git" class="bare">https://github.com/quarkusio/quarkus-quickstarts.git</a></code>, or download an <a href="https://github.com/quarkusio/quarkus-quickstarts/archive/main.zip">archive</a>.</p>
</div>
<div class="paragraph">
<p>The solution is located in the <code>liquibase-mongodb-quickstart</code> <a href="https://github.com/quarkusio/quarkus-quickstarts/tree/main/liquibase-mongodb-quickstart">directory</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="setting-up-support-for-liquibase"><a class="anchor" href="#setting-up-support-for-liquibase"></a>Setting up support for Liquibase</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To start using the Liquibase MongoDB Extension with your project, you just need to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>add your changeLog to the <code>{change-log}</code> file as you usually do with Liquibase</p>
</li>
<li>
<p>activate the <code>migrate-at-start</code> option to migrate the schema automatically or inject the <code>Liquibase</code> object and run
your migration as you normally do.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In your <code>pom.xml</code>, add the following dependencies:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the Liquibase MongoDB extension</p>
</li>
<li>
<p>the MongoDB client extension</p>
</li>
</ul>
</div>
<div class="listingblock primary asciidoc-tabs-target-sync-cli asciidoc-tabs-target-sync-maven">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;!-- Liquibase MongoDB --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
    &lt;artifactId&gt;quarkus-liquibase-mongodb&lt;/artifactId&gt;
&lt;/dependency&gt;

&lt;!-- MongoDB client dependency --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
    &lt;artifactId&gt;quarkus-mongodb-client&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary asciidoc-tabs-target-sync-gradle">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gradle hljs" data-lang="gradle">// Liquibase MongoDB
implementation("io.quarkus:quarkus-liquibase-mongodb")

// MongoDB client dependency
implementation("io.quarkus:quarkus-mongodb-client")</code></pre>
</div>
</div>
<div class="paragraph">
<p>Liquibase MongoDB extension support relies on the Quarkus MongoDB client config.
For the time being, it does not support multiple clients.
First, you need to add the MongoDB config to the <code>{config-file}</code> file
in order to allow Liquibase to manage the schema.</p>
</div>
<div class="paragraph">
<p>The following is an example for the <code>{config-file}</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties"># configure MongoDB
quarkus.mongodb.connection-string = mongodb://localhost:27017

# Liquibase MongoDB minimal config properties
quarkus.liquibase-mongodb.migrate-at-start=true

# Liquibase MongoDB optional config properties
# quarkus.liquibase-mongodb.change-log=db/changeLog.xml
# quarkus.liquibase-mongodb.validate-on-migrate=true
# quarkus.liquibase-mongodb.clean-at-start=false
# quarkus.liquibase-mongodb.contexts=Context1,Context2
# quarkus.liquibase-mongodb.labels=Label1,Label2
# quarkus.liquibase-mongodb.default-catalog-name=DefaultCatalog
# quarkus.liquibase-mongodb.default-schema-name=DefaultSchema</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add a changeLog file to the default folder following the Liquibase naming conventions: <code>{change-log}</code>
YAML, JSON and XML formats are supported for the changeLog.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.1" encoding="UTF-8" standalone="no"?&gt;
&lt;databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd
        http://www.liquibase.org/xml/ns/dbchangelog-ext https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd"&gt;

    &lt;changeSet id="1" author="loic"&gt;
        &lt;ext:createCollection collectionName="Fruit"/&gt;

        &lt;ext:createIndex collectionName="Fruit"&gt;
            &lt;ext:keys&gt;{color: 1}&lt;/ext:keys&gt;
            &lt;ext:options&gt;{name: "colorIdx"}&lt;/ext:options&gt;
        &lt;/ext:createIndex&gt;

        &lt;ext:insertOne collectionName="Fruit"&gt;
            &lt;ext:document&gt;{"name":"orange", "color": "orange"}&lt;/ext:document&gt;
        &lt;/ext:insertOne&gt;
    &lt;/changeSet&gt;

&lt;/databaseChangeLog&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you can start your application and Quarkus will run the Liquibase&#8217;s update method according to your config.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="using-the-liquibase-object"><a class="anchor" href="#using-the-liquibase-object"></a>Using the Liquibase object</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In case you are interested in using the <code>Liquibase</code> object directly, you can inject it as follows:</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you enabled the <code>quarkus.liquibase.migrate-at-start</code> property, by the time you use the Liquibase instance,
Quarkus will already have run the migrate operation.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import io.quarkus.liquibase.LiquibaseFactory;

@ApplicationScoped
public class MigrationService {
    // You can Inject the object if you want to use it manually
    @Inject
    LiquibaseMongodbFactory liquibaseMongodbFactory; <i class="conum" data-value="1"></i><b>(1)</b>

    public void checkMigration() {
        // Use the liquibase instance manually
        try (Liquibase liquibase = liquibaseFactory.createLiquibase()) {
            liquibase.dropAll(); <i class="conum" data-value="2"></i><b>(2)</b>
            liquibase.validate();
            liquibase.update(liquibaseFactory.createContexts(), liquibaseFactory.createLabels());
            // Get the list of liquibase change set statuses
            List&lt;ChangeSetStatus&gt; status = liquibase.getChangeSetStatuses(liquibaseFactory.createContexts(), liquibaseFactory.createLabels()); <i class="conum" data-value="3"></i><b>(3)</b>
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Inject the LiquibaseFactory object</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use the Liquibase instance directly</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>List of applied or not applied liquibase ChangeSets</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="liquibase-mongodb-on-kubernetes"><a class="anchor" href="#liquibase-mongodb-on-kubernetes"></a>Liquibase Mongodb on Kubernetes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Sometimes, it&#8217;s helpful not to execute Liquibase initialization on each application startup. One such example is when deploying
on Kubernetes, where it doesn&#8217;t make sense to execute Liquibase on every single replica. Instead it&#8217;s desirable to execute it
once and then start the actual application without Liquibase. To support this use case, when generating manifests for Kubernetes
the generated manifests contain a Kubernetes initialization <code>Job</code> for Liquibase.
The <code>Job</code> performs initialization and the actual <code>Pod</code>, will starts once the <code>Job</code> is successfully completed.</p>
</div>
<div class="paragraph">
<p>The feature is enabled by default and can be globally disabled, using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.kubernetes.externalize-init=false</code></pre>
</div>
</div>
<div class="paragraph">
<p>or on OpenShift:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.openshift.externalize-init=false</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Note</strong>: In this context globally means <code>for all extensions that support init task externalization</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuration-reference"><a class="anchor" href="#configuration-reference"></a>Configuration Reference</h2>
<div class="sectionbody">

</div>
</div>