<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The following guide demonstrates how a Quarkus application can use <a href="https://github.com/smallrye/smallrye-metrics/">SmallRye Metrics</a>,
an implementation of the <a href="https://github.com/eclipse/microprofile-metrics/">MicroProfile Metrics</a> specification.</p>
</div>
<div class="paragraph">
<p>SmallRye Metrics allows applications to gather metrics and statistics that provide insights into what is happening inside an application. The metrics can be read remotely using the JSON or OpenMetrics format to be processed by additional tools such as Prometheus and stored for analysis and visualization.</p>
</div>
<div class="paragraph">
<p>Apart from application-specific metrics described in this guide, you may also use built-in metrics exposed by various Quarkus extensions. These are described in the guide for each particular extension that supports built-in metrics.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p><a href="telemetry-micrometer">Micrometer</a> is the recommended approach to metrics for Quarkus. Use the SmallRye Metrics extension when it is required to retain MicroProfile specification compatibility.</p>
</div>
<div class="paragraph">
<p>When Quarkus will upgrade to Eclipse MicroProfile 6, the SmallRye Metrics support will be discontinued.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Unresolved directive in smallrye-metrics.adoc - include::{includes}/extension-status.adoc[]</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="prerequisites"><a class="anchor" href="#prerequisites"></a>Prerequisites</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Unresolved directive in smallrye-metrics.adoc - include::{includes}/prerequisites.adoc[]</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="architecture"><a class="anchor" href="#architecture"></a>Architecture</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this example, we build a very simple microservice that offers one REST endpoint. This endpoint serves for determining whether a number is prime. The implementation class is annotated with certain metric annotations so that while responding to users' requests, certain metrics are gathered. The meaning of each metric is explained later.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="solution"><a class="anchor" href="#solution"></a>Solution</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We recommend that you follow the instructions in the next sections and create the application step by step. However, you can skip to the completed example.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Clone the Git repository:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">git clone https://github.com/quarkusio/quarkus-quickstarts.git</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Alternatively, download a <a href="https://github.com/quarkusio/quarkus-quickstarts/archive/main.zip">Quickstarts archive</a>. The solution is located in the <code>microprofile-metrics-quickstart</code> <a href="https://github.com/quarkusio/quarkus-quickstarts/tree/main/microprofile-metrics-quickstart">directory</a> and follow with the <a href="#running-and-using-the-application_{context}">Running and using the application</a> section.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="creating-a-maven-project_{context}"><a class="anchor" href="#creating-a-maven-project_{context}"></a>Creating a Maven project</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To create a new project:</p>
</div>
<div class="paragraph">
<p>Unresolved directive in smallrye-metrics.adoc - include::{includes}/devtools/create-app.adoc[]</p>
</div>
<div class="paragraph">
<p>This command generates a Quarkus project that uses the <code>smallrye-metrics</code> extension.</p>
</div>
<div class="paragraph">
<p>If you already have your Quarkus project configured, you can add the <code>smallrye-metrics</code> extension to your project by running the following command in your project base directory:</p>
</div>
<div class="paragraph">
<p>Unresolved directive in smallrye-metrics.adoc - include::{includes}/devtools/extension-add.adoc[]</p>
</div>
<div class="paragraph">
<p>This adds the following to your build file:</p>
</div>
<div class="listingblock primary asciidoc-tabs-target-sync-cli asciidoc-tabs-target-sync-maven">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
    &lt;artifactId&gt;quarkus-smallrye-metrics&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary asciidoc-tabs-target-sync-gradle">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gradle hljs" data-lang="gradle">implementation("io.quarkus:quarkus-smallrye-metrics")</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="writing-an-application_{context}"><a class="anchor" href="#writing-an-application_{context}"></a>Writing an application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following procedures create a Quarkus application that consists of a single class that implements an algorithm for checking whether a number is prime. This algorithm is exposed over a REST interface. Additionally, specific annotations are required to ensure that the desired metrics are calculated over time and can be exported for manual analysis or processing by additional tooling.</p>
</div>
<div class="paragraph">
<p>The application will gather the following metrics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>performedChecks</code>: A counter that increases by one each time the user asks about a number.</p>
</li>
<li>
<p><code>highestPrimeNumberSoFar</code>: A gauge that stores the highest number asked about by the user if the number was determined to be prime.</p>
</li>
<li>
<p><code>checksTimer</code>: A compound metric that benchmarks how much time the primality tests take. Additional details are provided later.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The full source code looks as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme.microprofile.metrics;

import org.eclipse.microprofile.metrics.MetricUnits;
import org.eclipse.microprofile.metrics.annotation.Counted;
import org.eclipse.microprofile.metrics.annotation.Gauge;
import org.eclipse.microprofile.metrics.annotation.Timed;

import jakarta.ws.rs.GET;
import jakarta.ws.rs.Path;
import jakarta.ws.rs.Produces;
import jakarta.ws.rs.core.MediaType;

@Path("/")
public class PrimeNumberChecker {

    private long highestPrimeNumberSoFar = 2;

    @GET
    @Path("/{number}")
    @Produces(MediaType.TEXT_PLAIN)
    @Counted(name = "performedChecks", description = "How many primality checks have been performed.")
    @Timed(name = "checksTimer", description = "A measure of how long it takes to perform the primality test.", unit = MetricUnits.MILLISECONDS)
    public String checkIfPrime(long number) {
        if (number &lt; 1) {
            return "Only natural numbers can be prime numbers.";
        }
        if (number == 1) {
            return "1 is not prime.";
        }
        if (number == 2) {
            return "2 is prime.";
        }
        if (number % 2 == 0) {
            return number + " is not prime, it is divisible by 2.";
        }
        for (int i = 3; i &lt; Math.floor(Math.sqrt(number)) + 1; i = i + 2) {
            if (number % i == 0) {
                return number + " is not prime, is divisible by " + i + ".";
            }
        }
        if (number &gt; highestPrimeNumberSoFar) {
            highestPrimeNumberSoFar = number;
        }
        return number + " is prime.";
    }

    @Gauge(name = "highestPrimeNumberSoFar", unit = MetricUnits.NONE, description = "Highest prime number so far.")
    public Long highestPrimeNumberSoFar() {
        return highestPrimeNumberSoFar;
    }

}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="running-and-using-the-application_{context}"><a class="anchor" href="#running-and-using-the-application_{context}"></a>Running and using the application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To execute the application created in <a href="#writing-an-application_{context}">Writing an application</a>, do the following:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Run the microservice in dev mode:</p>
<div class="paragraph">
<p>Unresolved directive in smallrye-metrics.adoc - include::{includes}/devtools/dev.adoc[]
:!devtools-wrapped:</p>
</div>
</li>
<li>
<p>Generate values for the metrics.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Query the endpoint to determine whether some numbers are prime numbers:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl localhost:8080/350</code></pre>
</div>
</div>
<div class="paragraph">
<p>The application will respond that 350 is not a prime number because it can be divided by 2.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For large prime numbers, the test takes more time.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl localhost:8080/629521085409773</code></pre>
</div>
</div>
<div class="paragraph">
<p>The application will respond that 629521085409773 is a prime number.</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Perform additional calls with numbers of your choice.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Review the generated metrics:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -H"Accept: application/json" localhost:8080/q/metrics/application</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will receive a response such as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "org.acme.microprofile.metrics.PrimeNumberChecker.checksTimer" : {			                    <i class="conum" data-value="1"></i><b>(1)</b>
    "p50": 217.231273,										                                        <i class="conum" data-value="2"></i><b>(2)</b>
    "p75": 217.231273,
    "p95": 217.231273,
    "p98": 217.231273,
    "p99": 217.231273,
    "p999": 217.231273,
    "min": 0.58961,										                                            <i class="conum" data-value="3"></i><b>(3)</b>
    "mean": 112.15909190834819,								                                        <i class="conum" data-value="4"></i><b>(4)</b>
    "max": 217.231273,									                                            <i class="conum" data-value="5"></i><b>(5)</b>
    "stddev": 108.2721053982776,							    	                                <i class="conum" data-value="6"></i><b>(6)</b>
    "count": 2,											                                            <i class="conum" data-value="7"></i><b>(7)</b>
    "meanRate": 0.04943519091742238,							                                    <i class="conum" data-value="8"></i><b>(8)</b>
    "oneMinRate": 0.2232140583080189,
    "fiveMinRate": 0.3559527083952095,
    "fifteenMinRate": 0.38474303050928976
  },
  "org.acme.microprofile.metrics.PrimeNumberChecker.performedChecks" : 2,		                    <i class="conum" data-value="9"></i><b>(9)</b>
  "org.acme.microprofile.metrics.PrimeNumberChecker.highestPrimeNumberSoFar" : 629521085409773		<i class="conum" data-value="10"></i><b>(10)</b>
}</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>checksTimer</code>: A compound metric that benchmarks how much time the primality tests take. All durations are measured in milliseconds. It consists of these values below.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>p50, p75, p95, p99, p999</code>: Percentiles of the durations. For example, the value in <code>p95</code> means that 95 % of the measurements were faster than this duration.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>min</code>: The shortest duration it took to perform a primality test was probably performed for a small number.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>mean</code>: The mean value of the measured durations.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td><code>max</code>: The longest duration, probably it was with a large prime number.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td><code>stddev</code>: The standard deviation.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td><code>count</code>: The number of observations, the value of which is the same as <code>performedChecks</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td><code>meanRate, oneMinRate, fiveMinRate, fifteenMinRate</code>: Mean throughput and one-, five-, and fifteen-minute exponentially-weighted moving average throughput.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td><code>performedChecks</code>: A counter which is increased by one each time the user asks about a number.</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td><code>highestPrimeNumberSoFar</code>: A gauge that stores the highest number that was asked about by the user and which was determined to be prime.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you prefer an OpenMetrics export rather than the JSON format, remove the <code>-H"Accept: application/json"</code> argument from your command line.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Management interface</div>
<div class="paragraph">
<p>By default, the metrics are exposed on the main HTTP server.
You can expose them on a separate network interface and port by enabling the management interface with the
<code>quarkus.management.enabled=true</code> property.
Refer to the <a href="./management-interface-reference">management interface reference</a> for more information.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>