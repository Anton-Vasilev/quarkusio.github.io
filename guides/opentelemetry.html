<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This guide explains how your Quarkus application can utilize <a href="https://opentelemetry.io/">OpenTelemetry</a> (OTel) to provide
distributed tracing for interactive web applications.</p>
</div>
<div class="paragraph">
<p>OpenTelemetry Metrics and Logging are not yet supported.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>Quarkus now supports the OpenTelemetry Autoconfiguration for Traces. The configurations match what you can see at
<a href="https://github.com/open-telemetry/opentelemetry-java/blob/main/sdk-extensions/autoconfigure/README.md">OpenTelemetry SDK Autoconfigure</a>
with the <code>quarkus.*</code> prefix.</p>
</li>
<li>
<p>Extensions and the libraries they provide, are directly instrumented in Quarkus. The <strong>use of the <a href="https://opentelemetry.io/docs/instrumentation/java/automatic/">OpenTelemetry Agent</a> is not needed nor recommended</strong> due to context propagation issues between imperative and reactive libraries.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="prerequisites"><a class="anchor" href="#prerequisites"></a>Prerequisites</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Unresolved directive in opentelemetry.adoc - include::{includes}/prerequisites.adoc[]</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="architecture"><a class="anchor" href="#architecture"></a>Architecture</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this guide, we create a straightforward REST application to demonstrate distributed tracing.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="solution"><a class="anchor" href="#solution"></a>Solution</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We recommend that you follow the instructions in the next sections and create the application step by step.
However, you can skip right to the completed example.</p>
</div>
<div class="paragraph">
<p>Clone the Git repository: <code>git clone <a href="https://github.com/quarkusio/quarkus-quickstarts.git" class="bare">https://github.com/quarkusio/quarkus-quickstarts.git</a></code>, or download an <a href="https://github.com/quarkusio/quarkus-quickstarts/archive/main.zip">archive</a>.</p>
</div>
<div class="paragraph">
<p>The solution is located in the <code>opentelemetry-quickstart</code> <a href="https://github.com/quarkusio/quarkus-quickstarts/tree/main/opentelemetry-quickstart">directory</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="creating-the-maven-project"><a class="anchor" href="#creating-the-maven-project"></a>Creating the Maven project</h2>
<div class="sectionbody">
<div class="paragraph">
<p>First, we need a new project. Create a new project with the following command:</p>
</div>
<div class="paragraph">
<p>Unresolved directive in opentelemetry.adoc - include::{includes}/devtools/create-app.adoc[]</p>
</div>
<div class="paragraph">
<p>This command generates the Maven project and imports the <code>quarkus-opentelemetry</code> extension,
which includes the default OpenTelemetry support,
and a gRPC span exporter for <a href="https://github.com/open-telemetry/opentelemetry-specification/blob/main/specification/protocol/otlp.md">OTLP</a>.</p>
</div>
<div class="paragraph">
<p>If you already have your Quarkus project configured, you can add the <code>quarkus-opentelemetry</code> extension
to your project by running the following command in your project base directory:</p>
</div>
<div class="paragraph">
<p>Unresolved directive in opentelemetry.adoc - include::{includes}/devtools/extension-add.adoc[]</p>
</div>
<div class="paragraph">
<p>This will add the following to your build file:</p>
</div>
<div class="listingblock primary asciidoc-tabs-target-sync-cli asciidoc-tabs-target-sync-maven">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
    &lt;artifactId&gt;quarkus-opentelemetry&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary asciidoc-tabs-target-sync-gradle">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gradle hljs" data-lang="gradle">implementation("io.quarkus:quarkus-opentelemetry")</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="examine-the-jakarta-rest-resource"><a class="anchor" href="#examine-the-jakarta-rest-resource"></a>Examine the Jakarta REST resource</h3>
<div class="paragraph">
<p>Create a <code>src/main/java/org/acme/opentelemetry/TracedResource.java</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme.opentelemetry;

import jakarta.ws.rs.GET;
import jakarta.ws.rs.Path;
import jakarta.ws.rs.Produces;
import jakarta.ws.rs.core.MediaType;
import org.jboss.logging.Logger;

@Path("/hello")
public class TracedResource {

    private static final Logger LOG = Logger.getLogger(TracedResource.class);

    @GET
    @Produces(MediaType.TEXT_PLAIN)
    public String hello() {
        LOG.info("hello");
        return "hello";
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that there is no tracing specific code included in the application. By default, requests sent to this
endpoint will be traced without any required code changes.</p>
</div>
</div>
<div class="sect2">
<h3 id="create-the-configuration"><a class="anchor" href="#create-the-configuration"></a>Create the configuration</h3>
<div class="paragraph">
<p>There are no mandatory configurations for the extension to work.</p>
</div>
<div class="paragraph">
<p>If you need to change any of the default property values, here is an example on how to configure the default OTLP gRPC Exporter within the application, using the <code>src/main/resources/application.properties</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.application.name=myservice <i class="conum" data-value="1"></i><b>(1)</b>
quarkus.otel.exporter.otlp.traces.endpoint=http://localhost:4317 <i class="conum" data-value="2"></i><b>(2)</b>
quarkus.otel.exporter.otlp.traces.headers=authorization=Bearer my_secret <i class="conum" data-value="3"></i><b>(3)</b>
quarkus.log.console.format=%d{HH:mm:ss} %-5p traceId=%X{traceId}, parentId=%X{parentId}, spanId=%X{spanId}, sampled=%X{sampled} [%c{2.}] (%t) %s%e%n  <i class="conum" data-value="4"></i><b>(4)</b>

# Alternative to the console log
quarkus.http.access-log.pattern="...traceId=%{X,traceId} spanId=%{X,spanId}" <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>All spans created from the application will include an OpenTelemetry <code>Resource</code> indicating the span was created by the <code>myservice</code> application. If not set, it will default to the artifact id.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>gRPC endpoint to send spans. If not set, it will default to <code><a href="http://localhost:4317" class="bare">http://localhost:4317</a></code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Optional gRPC headers commonly used for authentication</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Add tracing information into log messages.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>You can also only put the trace info into the access log. In this case you must omit the info in the console log format.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>All configurations have been updated from <code>quarkus.opentelemetry.*</code> &#8594; <code>quarkus.otel.*</code></p>
</div>
<div class="paragraph">
<p>The legacy configurations are now deprecated but will still work during a transition period.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="run-the-application"><a class="anchor" href="#run-the-application"></a>Run the application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The first step is to configure and start the <a href="https://opentelemetry.io/docs/collector/">OpenTelemetry Collector</a> to receive, process and export telemetry data to <a href="https://www.jaegertracing.io/">Jaeger</a> that will display the captured traces.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Jaeger-all-in-one includes the Jaeger agent, an OTel collector, and the query service/UI.
You do not need to install a separated collector. You can directly send the trace data to Jaeger (after enabling OTLP receivers there, see e.g. this
<a href="https://medium.com/jaegertracing/introducing-native-support-for-opentelemetry-in-jaeger-eb661be8183c">blog entry</a> for details).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Start the OpenTelemetry Collector and Jaeger system via the following <code>docker-compose.yml</code> file that you can launch via <code>docker-compose up -d</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">version: "2"
services:

  # Jaeger
  jaeger-all-in-one:
    image: jaegertracing/all-in-one:latest
    ports:
      - "16686:16686" # Jaeger UI
      - "14268:14268" # Receive legacy OpenTracing traces, optional
      - "4317:4317"   # OTLP gRPC receiver
      - "4318:4318"   # OTLP HTTP receiver, not yet used by Quarkus, optional
      - "14250:14250" # Receive from external otel-collector, optional
    environment:
      - COLLECTOR_OTLP_ENABLED=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should remove the optional ports you don&#8217;t need them.</p>
</div>
<div class="paragraph">
<p>Now we are ready to run our application. If using <code>application.properties</code> to configure the tracer:</p>
</div>
<div class="paragraph">
<p>Unresolved directive in opentelemetry.adoc - include::{includes}/devtools/dev.adoc[]</p>
</div>
<div class="paragraph">
<p>or if configuring the OTLP gRPC endpoint via JVM arguments:</p>
</div>
<div class="paragraph">
<p>Unresolved directive in opentelemetry.adoc - include::{includes}/devtools/dev.adoc[]
:!dev-additional-parameters:</p>
</div>
<div class="paragraph">
<p>With the OpenTelemetry Collector, the Jaeger system and the application running, you can make a request to the provided endpoint:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ curl http://localhost:8080/hello
hello</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the first request has been submitted, you will be able to see the tracing information in the logs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">10:49:02 INFO  traceId=, parentId=, spanId=, sampled= [io.quarkus] (main) Installed features: [cdi, opentelemetry, rest-client, resteasy, smallrye-context-propagation, vertx]
10:49:03 INFO  traceId=17ceb8429b9f25b0b879fa1503259456, parentId=3125c8bee75b7ad6, spanId=58ce77c86dd23457, sampled=true [or.ac.op.TracedResource] (executor-thread-1) hello
10:49:03 INFO  traceId=ad23acd6d9a4ed3d1de07866a52fa2df, parentId=, spanId=df13f5b45cf4d1e2, sampled=true [or.ac.op.TracedResource] (executor-thread-0) hello</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then visit the <a href="http://localhost:16686">Jaeger UI</a> to see the tracing information.</p>
</div>
<div class="paragraph">
<p>Hit <code>CTRL+C</code> or type <code>q</code> to stop the application.</p>
</div>
<div class="sect2">
<h3 id="jdbc"><a class="anchor" href="#jdbc"></a>JDBC</h3>
<div class="paragraph">
<p>The <a href="https://github.com/open-telemetry/opentelemetry-java-instrumentation/tree/main/instrumentation/jdbc/library">JDBC instrumentation</a> will add a span for each JDBC queries done by your application, to enable it, add the following dependency to your build file:</p>
</div>
<div class="listingblock primary asciidoc-tabs-target-sync-cli asciidoc-tabs-target-sync-maven">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.opentelemetry.instrumentation&lt;/groupId&gt;
    &lt;artifactId&gt;opentelemetry-jdbc&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary asciidoc-tabs-target-sync-gradle">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gradle hljs" data-lang="gradle">implementation("io.opentelemetry.instrumentation:opentelemetry-jdbc")</code></pre>
</div>
</div>
<div class="paragraph">
<p>As it uses a dedicated JDBC datasource wrapper, you must enable telemetry for your datasource:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties"># enable tracing
quarkus.datasource.jdbc.telemetry=true

# configure datasource
quarkus.datasource.db-kind=postgresql
quarkus.datasource.jdbc.url=jdbc:postgresql://localhost:5432/mydatabase</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="additional-configuration"><a class="anchor" href="#additional-configuration"></a>Additional configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Some use cases will require custom configuration of OpenTelemetry.
These sections will outline what is necessary to properly configure it.</p>
</div>
<div class="sect2">
<h3 id="id-generator"><a class="anchor" href="#id-generator"></a>ID Generator</h3>
<div class="paragraph">
<p>The OpenTelemetry extension will use by default a random <a href="https://github.com/open-telemetry/opentelemetry-specification/blob/main/specification/trace/sdk.md#id-generators">ID Generator</a>
when creating the trace and span identifier.</p>
</div>
<div class="paragraph">
<p>Some vendor-specific protocols need a custom ID Generator, you can override the default one by creating a producer.
The OpenTelemetry extension will detect the <code>IdGenerator</code> CDI bean and will use it when configuring the tracer producer.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Singleton
public class CustomConfiguration {

    /** Creates a custom IdGenerator for OpenTelemetry */
    @Produces
    @Singleton
    public IdGenerator idGenerator() {
        return AwsXrayIdGenerator.getInstance();
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="propagators"><a class="anchor" href="#propagators"></a>Propagators</h3>
<div class="paragraph">
<p>OpenTelemetry propagates cross-cutting concerns through <a href="https://github.com/open-telemetry/opentelemetry-specification/blob/main/specification/context/api-propagators.md">propagators</a> that will share an underlying <code>Context</code> for storing state and accessing
data across the lifespan of a distributed transaction.</p>
</div>
<div class="paragraph">
<p>By default, the OpenTelemetry extension enables the <a href="https://www.w3.org/TR/trace-context/">W3C Trace Context</a> and the <a href="https://www.w3.org/TR/baggage/">W3C Baggage</a>
propagators, you can however choose any of the supported OpenTelemetry propagators by setting the <code>propagators</code> config that is described in the <a href="#configuration-reference">OpenTelemetry Configuration Reference</a>.</p>
</div>
<div class="sect3">
<h4 id="additional-propagators"><a class="anchor" href="#additional-propagators"></a>Additional Propagators</h4>
<div class="ulist">
<ul>
<li>
<p>The <code>b3</code>, <code>b3multi</code>, <code>jaeger</code> and <code>ottrace</code> propagators will need the <a href="https://github.com/open-telemetry/opentelemetry-java/tree/main/extensions/trace-propagators">trace-propagators</a>
extension to be added as a dependency to your project.</p>
</li>
</ul>
</div>
<div class="listingblock primary asciidoc-tabs-target-sync-cli asciidoc-tabs-target-sync-maven">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.opentelemetry&lt;/groupId&gt;
    &lt;artifactId&gt;opentelemetry-extension-trace-propagators&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary asciidoc-tabs-target-sync-gradle">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gradle hljs" data-lang="gradle">implementation("io.opentelemetry:opentelemetry-extension-trace-propagators")</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>xray</code> propagator will need the <a href="https://github.com/open-telemetry/opentelemetry-java-contrib/tree/main/aws-xray-propagator">aws</a>
extension to be added as a dependency to your project.</p>
</li>
</ul>
</div>
<div class="listingblock primary asciidoc-tabs-target-sync-cli asciidoc-tabs-target-sync-maven">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.opentelemetry.contrib&lt;/groupId&gt;
    &lt;artifactId&gt;opentelemetry-aws-xray-propagator&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary asciidoc-tabs-target-sync-gradle">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gradle hljs" data-lang="gradle">implementation("io.opentelemetry.contrib:opentelemetry-aws-xray-propagator")</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="resource"><a class="anchor" href="#resource"></a>Resource</h3>
<div class="paragraph">
<p>A <a href="https://github.com/open-telemetry/opentelemetry-specification/blob/main/specification/overview.md#resources">resource</a> is a representation
of the entity that is producing telemetry, it adds attributes to the exported trace to characterize who is producing the trace.</p>
</div>
<div class="paragraph">
<p>You can add attributes by setting the <code>resource-attributes</code> tracer config that is described in the <a href="#configuration-reference">OpenTelemetry Configuration Reference</a>.
Since this property can be overridden at runtime, the OpenTelemetry extension will pick up its value following the order of precedence that
is described in the <a href="config-reference#configuration-sources">Quarkus Configuration Reference</a>.</p>
</div>
<div class="paragraph">
<p>If by any means you need to use a custom resource or one that is provided by one of the <a href="https://github.com/open-telemetry/opentelemetry-java/tree/main/sdk-extensions">OpenTelemetry SDK Extensions</a>
you can create multiple resource producers. The OpenTelemetry extension will detect the <code>Resource</code> CDI beans and will merge them when configuring the tracer producer.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ApplicationScoped
public class CustomConfiguration {

    @Produces
    @ApplicationScoped
    public Resource osResource() {
        return OsResource.get();
    }

    @Produces
    @ApplicationScoped
    public Resource ecsResource() {
        return EcsResource.get();
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sampler"><a class="anchor" href="#sampler"></a>Sampler</h3>
<div class="paragraph">
<p>A <a href="https://github.com/open-telemetry/opentelemetry-specification/blob/main/specification/trace/sdk.md#sampling">sampler</a> decides whether
a trace should be sampled and exported, controlling noise and overhead by reducing the number of sample of traces collected and sent
to the collector.</p>
</div>
<div class="paragraph">
<p>You can set a <a href="https://github.com/open-telemetry/opentelemetry-specification/blob/main/specification/trace/sdk.md#built-in-samplers">built-in sampler</a>
simply by setting the desired sampler config described in the <a href="#configuration-reference">OpenTelemetry Configuration Reference</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Quarkus 3.0 introduced breaking changes on the configuration.</p>
</div>
<div class="paragraph">
<p>Sampler related property names and values change to comply with the latest Java OpenTelemetry SDK. During a transition period it will be possible to set the new configuration values in the old property because we are mapping  <code>quarkus.opentelemetry.tracer.sampler</code> &#8594; <code>quarkus.otel.traces.sampler</code>.</p>
</div>
<div class="paragraph">
<p>If the sampler is parent based, there is no need to set, the now dropped property, <code>quarkus.opentelemetry.tracer.sampler.parent-based</code>.</p>
</div>
<div class="paragraph">
<p>The values you need to set on <code>quarkus.opentelemetry.tracer.sampler</code> are now:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Old Sampler config value</th>
<th class="tableblock halign-left valign-top">New Sampler config value</th>
<th class="tableblock halign-left valign-top">New Sampler config value (Parent based)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>on</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>always_on</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>parentbased_always_on</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>off</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>always_off</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>parentbased_always_off</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ratio</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>traceidratio</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>parentbased_traceidratio</code></p></td>
</tr>
</tbody>
</table>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you need to use a custom sampler there are now 2 different ways:</p>
</div>
<div class="sect3">
<h4 id="sampler-cdi-producer"><a class="anchor" href="#sampler-cdi-producer"></a>Sampler CDI Producer</h4>
<div class="paragraph">
<p>You can create a sampler CDI producer. The Quarkus OpenTelemetry extension will detect the <code>Sampler</code> CDI bean and will use it when configuring the Tracer.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Singleton
public class CustomConfiguration {

    /** Creates a custom sampler for OpenTelemetry */
    @Produces
    @Singleton
    public Sampler sampler() {
        return JaegerRemoteSampler.builder()
        .setServiceName("my-service")
        .build();
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="otel-sampler-spi"><a class="anchor" href="#otel-sampler-spi"></a>OTel Sampler SPI</h4>
<div class="paragraph">
<p>This will use the SPI hooks available with the OTel Autoconfiguration.
You can create a simple Sampler class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class CustomSPISampler implements Sampler {
    @Override
    public SamplingResult shouldSample(Context context,
            String s,
            String s1,
            SpanKind spanKind,
            Attributes attributes,
            List&lt;LinkData&gt; list) {
        // Do some sampling here
        return Sampler.alwaysOn().shouldSample(context, s, s1, spanKind, attributes, list);
    }

    @Override
    public String getDescription() {
        return "custom-spi-sampler-description";
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then a Sampler Provider:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class CustomSPISamplerProvider implements ConfigurableSamplerProvider {
    @Override
    public Sampler createSampler(ConfigProperties configProperties) {
        return new CustomSPISampler();
    }

    @Override
    public String getName() {
        return "custom-spi-sampler";
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Write the SPI loader text file at <code>resources/META-INF/services</code> with name <code>io.opentelemetry.sdk.autoconfigure.spi.traces.ConfigurableSamplerProvider</code> containing the full qualified name of the <code>CustomSPISamplerProvider</code> class.</p>
</div>
<div class="paragraph">
<p>Then activate on the configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.otel.traces.sampler=custom-spi-sampler</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, CDI is much simpler to work with.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="additional-instrumentation"><a class="anchor" href="#additional-instrumentation"></a>Additional instrumentation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Some Quarkus extensions will require additional code to ensure traces are propagated to subsequent execution.
These sections will outline what is necessary to propagate traces across process boundaries.</p>
</div>
<div class="paragraph">
<p>The instrumentation documented in this section has been tested with Quarkus and works in both standard and native mode.</p>
</div>
<div class="sect2">
<h3 id="cdi"><a class="anchor" href="#cdi"></a>CDI</h3>
<div class="paragraph">
<p>Annotating a method in any CDI aware bean with the <code>io.opentelemetry.instrumentation.annotations.WithSpan</code>
annotation will create a new Span and establish any required relationships with the current Trace context.</p>
</div>
<div class="paragraph">
<p>Method parameters can be annotated with the <code>io.opentelemetry.instrumentation.annotations.SpanAttribute</code> annotation to
indicate which method parameters should be part of the Trace.</p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ApplicationScoped
class SpanBean {
    @WithSpan
    void span() {

    }

    @WithSpan("name")
    void spanName() {

    }

    @WithSpan(kind = SERVER)
    void spanKind() {

    }

    @WithSpan
    void spanArgs(@SpanAttribute(value = "arg") String arg) {

    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="available-opentelemetry-cdi-injections"><a class="anchor" href="#available-opentelemetry-cdi-injections"></a>Available OpenTelemetry CDI injections</h3>
<div class="paragraph">
<p>As per MicroProfile Telemetry Tracing specification, Quarkus supports the CDI injections of the
following classes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>io.opentelemetry.api.OpenTelemetry</code></p>
</li>
<li>
<p><code>io.opentelemetry.api.trace.Tracer</code></p>
</li>
<li>
<p><code>io.opentelemetry.api.trace.Span</code></p>
</li>
<li>
<p><code>io.opentelemetry.api.baggage.Baggage</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can inject these classes in any CDI enabled bean. For instance, the <code>Tracer</code> is particularly useful to start custom spans:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Inject
Tracer tracer;

...

public void tracedWork() {
    Span span = tracer.spanBuilder("My custom span")
        .setAttribute("attr", "attr.value")
        .setParent(Context.current().with(Span.current()))
        .setSpanKind(SpanKind.INTERNAL)
        .startSpan();

    // traced work

    span.end();
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="smallrye-reactive-messaging-kafka"><a class="anchor" href="#smallrye-reactive-messaging-kafka"></a>SmallRye Reactive Messaging - Kafka</h3>
<div class="paragraph">
<p>When using the SmallRye Reactive Messaging extension for Kafka,
we are able to propagate the span into the Kafka Record with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">TracingMetadata tm = TracingMetadata.withPrevious(Context.current());
Message out = Message.of(...).withMetadata(tm);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above creates a <code>TracingMetadata</code> object we can add to the <code>Message</code> being produced,
which retrieves the OpenTelemetry <code>Context</code> to extract the current span for propagation.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="exporters"><a class="anchor" href="#exporters"></a>Exporters</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Quarkus OpenTelemetry defaults to the standard OTLP exporter defined in OpenTelemetry.</p>
</div>
<div class="paragraph">
<p>Additional exporters will be available in the Quarkiverse <a href="https://github.com/quarkiverse/quarkus-opentelemetry-exporter/blob/main/README.md">quarkus-opentelemetry-exporter</a> project.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuration-reference"><a class="anchor" href="#configuration-reference"></a>OpenTelemetry Configuration Reference</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Quarkus supports the OpenTelemetry Autoconfiguration for Traces.
The configurations match what you can see at
<a href="https://github.com/open-telemetry/opentelemetry-java/blob/main/sdk-extensions/autoconfigure/README.md">OpenTelemetry SDK Autoconfigure</a>
adding the usual <code>quarkus.*</code> prefix.</p>
</div>
<div class="paragraph">
<p>Quarkus OpenTelemetry configuration properties now have the <code>quarkus.otel.*</code> prefix.</p>
</div>
<div class="paragraph">
<p><strong>The legacy properties</strong> with prefix <code>quarkus.opentelemetry.*</code> are currently being mapped to the new ones as a default, during a transition period. See Default column in the details below.</p>
</div>
</div>
</div>