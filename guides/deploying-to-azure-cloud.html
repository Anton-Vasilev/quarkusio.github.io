<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This guide covers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Update Quarkus HTTP Port</p>
</li>
<li>
<p>Install the Azure CLI</p>
</li>
<li>
<p>Create an Azure Registry Service instance and upload the Docker image</p>
</li>
<li>
<p>Deploy the Docker image to Azure Container Instances</p>
</li>
<li>
<p>Deploy the Docker image to Azure Kubernetes Service</p>
</li>
<li>
<p>Deploy the Docker image to Azure App Service for Linux Containers</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="prerequisites"><a class="anchor" href="#prerequisites"></a>Prerequisites</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Unresolved directive in deploying-to-azure-cloud.adoc - include::{includes}/prerequisites.adoc[]
* Having access to an Azure subscription. <a href="https://azure.microsoft.com/free/?WT.mc_id=opensource-quarkus-brborges">Get a free one here</a></p>
</div>
<div class="paragraph">
<p>This guide will take as input a native application developed in the <a href="building-native-image">building native image guide</a>.</p>
</div>
<div class="paragraph">
<p>Make sure you have the getting-started application at hand, or clone the Git repository: <code>git clone <a href="https://github.com/quarkusio/quarkus-quickstarts.git" class="bare">https://github.com/quarkusio/quarkus-quickstarts.git</a></code>, or download an <a href="https://github.com/quarkusio/quarkus-quickstarts/archive/main.zip">archive</a>. The solution is located in the <code>getting-started</code> directory.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="change-quarkus-http-port"><a class="anchor" href="#change-quarkus-http-port"></a>Change Quarkus HTTP Port</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you correctly followed the <a href="building-native-image">building native image guide</a>, you should have a local container image named <code>quarkus-quickstart/getting-started</code>.</p>
</div>
<div class="paragraph">
<p>While Quarkus by default runs on port 8080, most Azure services expect web applications to be running on port 80. Before we continue, go back to your quickstart code and open the file <code>src/main/docker/Dockerfile.native</code>.</p>
</div>
<div class="paragraph">
<p>Change the last two commands in the <code>Dockerfile.native</code> file and make it read like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-docker hljs" data-lang="docker">EXPOSE 80
CMD ["./application", "-Dquarkus.http.host=0.0.0.0", "-Dquarkus.http.port=80"]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you can rebuild the docker image:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ docker build -f src/main/docker/Dockerfile.native -t quarkus-quickstart/getting-started .</code></pre>
</div>
</div>
<div class="paragraph">
<p>To test, run it by exposing port 80 into port 8080 in your host:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ docker run -i --rm -p 8080:80 quarkus-quickstart/getting-started</code></pre>
</div>
</div>
<div class="paragraph">
<p>Your container image is now ready to run on Azure. Remember, the Quarkus application is mapped to run on port 80.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="install-the-azure-cli"><a class="anchor" href="#install-the-azure-cli"></a>Install the Azure CLI</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To ease the user experience throughout this guide, it is better to have the Azure CLI installed and authenticated.</p>
</div>
<div class="paragraph">
<p>Visit the <a href="https://docs.microsoft.com/cli/azure/install-azure-cli?view=azure-cli-latest?WT.mc_id=opensource-quarkus-brborges">Azure CLI</a> installation page for instructions specific to your operating system.</p>
</div>
<div class="paragraph">
<p>Once installed, ensure you are authenticated:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ az login</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="create-an-azure-container-registry-instance"><a class="anchor" href="#create-an-azure-container-registry-instance"></a>Create an Azure Container Registry instance</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It is possible to deploy images hosted on Docker Hub, but this location by default leaves images accessible to anyone. To better protect your container images, this guide shows how to host your images on a private instance of the Azure Container Registry service.</p>
</div>
<div class="paragraph">
<p>First, create an Azure Resource Group:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ az group create --name &lt;resource-group-name&gt; --location eastus</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you can create the ACR:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ az acr create --resource-group &lt;resource-group-name&gt; --name &lt;registry-name&gt; --sku Basic --admin-enabled true</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, authenticate your local Docker installation with this container registry by running:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ az acr login --name &lt;registry-name&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="upload-container-image-on-azure"><a class="anchor" href="#upload-container-image-on-azure"></a>Upload Container Image on Azure</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you&#8217;ve followed the build native image guide, you should have a local container image named <code>quarkus-quickstart/getting-started</code>.</p>
</div>
<div class="paragraph">
<p>To upload this image to your ACR, you must tag and push the image under the ACR login server. To find the login server of the Azure Container Registry, run this command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ az acr show -n &lt;registry-name&gt; --query loginServer -o tsv</code></pre>
</div>
</div>
<div class="paragraph">
<p>To upload, now do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ docker tag quarkus-quickstart/getting-started &lt;acr-login-server&gt;/quarkus-quickstart/getting-started
$ docker push &lt;acr-login-server&gt;/quarkus-quickstart/getting-started</code></pre>
</div>
</div>
<div class="paragraph">
<p>At this point, you should have your Quarkus container image on your Azure Container Registry. To verify, run the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ az acr repository list -n &lt;registry-name&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploy-to-azure-container-instances"><a class="anchor" href="#deploy-to-azure-container-instances"></a>Deploy to Azure Container Instances</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The simplest way to start this container in the cloud is with the Azure Container Instances service. It simply creates a container on Azure infrastructure.</p>
</div>
<div class="paragraph">
<p>There are different approaches for using ACI. Check the documentation for details. The quickest way to get a container up and running goes as it follows.</p>
</div>
<div class="paragraph">
<p>First step is to find the username and password for the admin, so that ACI can authenticate into ACR and pull the Docker image:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ az acr credential show --name &lt;registry-name&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now create the Docker instance on ACI pointing to your image on ACR:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ az container create \
    --name quarkus-hello \
    --resource-group &lt;resource-group&gt; \
    --image &lt;acr-login-server&gt;/quarkus-quickstart/getting-started \
    --registry-login-server &lt;acr-login-server&gt; \
    --registry-username &lt;acr-username&gt; \
    --registry-password &lt;acr-password&gt; \
    --dns-name-label quarkus-hello-&lt;random-number&gt; \
    --query ipAddress.fqdn</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command above, if run successfully, will give you the address of your container in the Cloud. Access your Quarkus application in the address displayed as output.</p>
</div>
<div class="paragraph">
<p>For more information and details on ACR authentication and the use of service principals, follow this guide below and remember the Azure Container Registry <code>loginServer</code> and the image name of your Quarkus application now hosted on the ACR.</p>
</div>
<div class="paragraph">
<p><a href="https://docs.microsoft.com/en-us/azure/container-instances/container-instances-using-azure-container-registry?WT.mc_id=opensource-quarkus-brborges">Deploy to Azure Container Instances from Azure Container Registry</a></p>
</div>
<div class="paragraph">
<p>Keep in mind that this service does not provide scalability. A container instance is unique and does not scale.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploy-to-azure-kubernetes-service"><a class="anchor" href="#deploy-to-azure-kubernetes-service"></a>Deploy to Azure Kubernetes Service</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can also deploy the container image as a microservice in a Kubernetes cluster on Azure. To do that, follow this tutorial:</p>
</div>
<div class="paragraph">
<p><a href="https://docs.microsoft.com/en-us/azure/aks/tutorial-kubernetes-deploy-cluster?WT.mc_id=opensource-quarkus-brborges">Tutorial: Deploy an Azure Kubernetes Service (AKS) cluster</a></p>
</div>
<div class="paragraph">
<p>Once deployed, the application will be running on whatever port is used to expose the service. By default, Quarkus apps run on port 8080 internally.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploy-to-azure-app-service-on-linux-containers"><a class="anchor" href="#deploy-to-azure-app-service-on-linux-containers"></a>Deploy to Azure App Service on Linux Containers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This service provides scalability out of the box for web applications. If more instances are required, it will provide a load-balancing automatically, plus monitoring, metrics, logging and so on.</p>
</div>
<div class="paragraph">
<p>To deploy your Quarkus Native container image to this service, follow this tutorial:</p>
</div>
<div class="paragraph">
<p><a href="https://docs.microsoft.com/en-us/azure/app-service/containers/tutorial-custom-docker-image?WT.mc_id=opensource-quarkus-brborges">Tutorial: Build a custom image and run in App Service from a private registry</a></p>
</div>
</div>
</div>