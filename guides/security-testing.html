<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Unresolved directive in _attributes.adoc - include::_attributes-local.adoc[]</p>
</div>
<div class="paragraph">
<p>This document describes how to test Quarkus Security.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuring-user-information"><a class="anchor" href="#configuring-user-information"></a>Configuring User Information</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can use <a href="security-properties">quarkus-elytron-security-properties-file</a> for testing security. This supports both embedding user info in <code>application.properties</code> and standalone properties files.</p>
</div>
<div class="paragraph">
<p>For example, the following configuration will allow for configuring the users in both the production where OAuth2 is required and development modes using <a href="config-reference#profiles">Configuration Profiles</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties"># Configure embedded authentication
%dev.quarkus.security.users.embedded.enabled=true
%dev.quarkus.security.users.embedded.plain-text=true
%dev.quarkus.security.users.embedded.users.scott=reader
%dev.quarkus.security.users.embedded.users.stuart=writer
%dev.quarkus.security.users.embedded.roles.scott=READER
%dev.quarkus.security.users.embedded.roles.stuart=READER,WRITER

# Configure OAuth2
quarkus.oauth2.enabled=true
%dev.quarkus.oauth2.enabled=false
quarkus.oauth2.client-id=client-id
quarkus.oauth2.client-secret=client-secret
quarkus.oauth2.introspection-url=http://host:port/introspect</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="testing-security"><a class="anchor" href="#testing-security"></a>Test Security Extension</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Quarkus provides explicit support for testing with different users, and with the security subsystem disabled. To use
this you must include the <code>quarkus-test-security</code> dependency:</p>
</div>
<div class="listingblock primary asciidoc-tabs-target-sync-cli asciidoc-tabs-target-sync-maven">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
    &lt;artifactId&gt;quarkus-test-security&lt;/artifactId&gt;
    &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary asciidoc-tabs-target-sync-gradle">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gradle hljs" data-lang="gradle">testImplementation("io.quarkus:quarkus-test-security")</code></pre>
</div>
</div>
<div class="paragraph">
<p>This artifact provides the <code>io.quarkus.test.security.TestSecurity</code> annotation, that can be applied to test methods and
test classes to control the security context that the test is run with. This allows you to do two things, you can disable
authorization so tests can access secured endpoints without needing to be authenticated, and you can specify the identity
that you want the tests to run under.</p>
</div>
<div class="paragraph">
<p>A test that runs with authorization disabled can just set the enabled property to false:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Test
@TestSecurity(authorizationEnabled = false)
void someTestMethod() {
...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will disable all access checks, which allows the test to access secured endpoints without needing to authenticate.</p>
</div>
<div class="paragraph">
<p>You can also use this to configure the current user that the test will run as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Test
@TestSecurity(user = "testUser", roles = {"admin", "user"})
void someTestMethod() {
...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will run the test with an identity with the given username and roles. Note that these can be combined, so you can
disable authorization while also providing an identity to run the test under, which can be useful if the endpoint expects an
identity to be present.</p>
</div>
<div class="paragraph">
<p>See <a href="security-oidc-bearer-token-authentication#integration-testing-security-annotation">OpenID Connect Bearer Token Integration testing</a>, <a href="security-oidc-code-flow-authentication#integration-testing-security-annotation">OpenID Connect Authorization Code Flow Integration testing</a> and <a href="security-jwt#integration-testing-security-annotation">SmallRye JWT Integration testing</a> for more details about testing the endpoint code which depends on the injected <code>JsonWebToken</code>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The feature is only available for <code>@QuarkusTest</code> and will <strong>not</strong> work on a <code>@QuarkusIntegrationTest</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>@TestSecurity</code> can also be used in meta-annotations, for example like so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    @Retention(RetentionPolicy.RUNTIME)
    @Target({ ElementType.METHOD })
    @TestSecurity(user = "testUser", roles = {"admin", "user"})
    public @interface TestSecurityMetaAnnotation {

    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is particularly useful if the same set of security settings needs to be used in multiple test methods.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="mixing-security-tests"><a class="anchor" href="#mixing-security-tests"></a>Mixing security tests</h3>
<div class="paragraph">
<p>If it becomes necessary to test security features using both <code>@TestSecurity</code> and Basic Auth (which is the fallback auth
mechanism when none is defined), then Basic Auth needs to be enabled explicitly,
for example by setting <code>quarkus.http.auth.basic=true</code> or <code>%test.quarkus.http.auth.basic=true</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="use-wiremock-for-integration-testing"><a class="anchor" href="#use-wiremock-for-integration-testing"></a>Use Wiremock for Integration Testing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can also use Wiremock to mock the authorization OAuth2 and OIDC services:
See <a href="security-oauth2#integration-testing">OAuth2 Integration testing</a>, <a href="security-oidc-bearer-token-authentication#integration-testing-wiremock">OpenID Connect Bearer Token Integration testing</a>, <a href="security-oidc-code-flow-authentication#integration-testing-wiremock">OpenID Connect Authorization Code Flow Integration testing</a> and <a href="security-jwt#integration-testing-wiremock">SmallRye JWT Integration testing</a> for more details.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="references"><a class="anchor" href="#references"></a>References</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="security-overview">Quarkus Security overview</a></p>
</li>
</ul>
</div>
</div>
</div>